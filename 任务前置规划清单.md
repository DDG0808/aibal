# AI 使用量追踪器 - 任务前置规划清单

> **版本**: v1.0
> **审核**: Codex (gpt-5.2 + xhigh reasoning) 评分 78/100
> **创建时间**: 2025-12-27
> **基于文档**: 功能清单.md、插件系统设计文档.md、功能清单-插件优先架构.md

---

## 一、项目概述

| 属性 | 描述 |
|------|------|
| **类型** | macOS 跨平台菜单栏应用 |
| **技术栈** | Rust + Tauri 2.0 / Vue 3.x (TypeScript) |
| **插件运行时** | QuickJS (rquickjs 0.6) |
| **架构模式** | 全外置插件 (All-External Plugins) |
| **核心理念** | 应用核心 = 纯运行时，所有功能 = 可热更新外置插件 |

---

## 二、执行阶段总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Phase 0: 契约冻结 (Gate)                                                │
│  ────────────────────────────────────────────────────────────────────── │
│  冻结 manifest.json / PluginContext / IPC Commands / 事件命名规范         │
│  ⚠️ 必须先完成，作为后续所有 Phase 的合流点                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│  Phase 1: 基础设施层                                                     │
│  ────────────────────────────────────────────────────────────────────── │
│  1.1 项目脚手架 ───────┐                                                 │
│  1.2 类型系统定义 ──────┤ 可并行                                          │
│  1.3 数据持久化 ───────┘                                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│  Phase 2: 插件运行时核心          │  Phase 5A: 安全工具链 (可并行)          │
│  ─────────────────────────────── │ ──────────────────────────────────── │
│  2.1 QuickJS 集成                │  5A.1 签名工具实现                     │
│  2.2 沙盒安全层                  │  5A.2 完整性校验库                     │
│  2.3 生命周期管理                │  5A.3 安全解压器                       │
│  2.4 安全验证强制点 ←────────────│← 5A 工具必须在此集成                    │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│  Phase 3: 可靠性层                │  Phase 7: 平台层 (可并行)              │
│  ─────────────────────────────── │ ──────────────────────────────────── │
│  3.1 并发调度器                  │  7.1 系统托盘                          │
│  3.2 限流器                      │  7.2 窗口管理                          │
│  3.3 缓存层                      │  7.3 IPC Commands                      │
│  3.4 重试机制                    │                                        │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│  Phase 4: 通信与配置              │  Phase 6: 监控层 (可并行)              │
│  ─────────────────────────────── │ ──────────────────────────────────── │
│  4.1 通信总线                    │  6.1 健康状态监控                      │
│  4.2 配置管理                    │  6.2 调用统计                          │
│  4.3 权限控制                    │  6.3 告警机制                          │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│  Phase 8: 展示层                                                         │
│  ────────────────────────────────────────────────────────────────────── │
│  8.1 托盘弹窗 UI ──────┐                                                 │
│  8.2 设置界面 ─────────┤ 可并行                                          │
│  8.3 仪表盘 ──────────┘                                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────┐
│  Phase 9: 官方插件                                                       │
│  ────────────────────────────────────────────────────────────────────── │
│  9.1 claude-usage.js ──────┐                                            │
│  9.2 claude-status.js ─────┤ 可并行                                     │
│  9.3 claude-balance.js ────┤                                            │
│  9.4 notifications.js ─────┘                                            │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、Phase 0: 契约冻结 (Gate) ⚠️ 关键前置

> **Codex 审核建议**: 必须显式新增此 Phase，作为后续所有实现的合流点

### 0.1 manifest.json Schema 冻结

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 0.1.1 | 定义 manifest.json 完整 Schema | JSON Schema 文件存在且有版本号 | [x] |
| 0.1.2 | 定义 `apiVersion` 兼容策略 | 明确 major/minor 升级规则 | [x] |
| 0.1.3 | 定义签名字段规范 (JSON 规范化) | 明确字段排序、编码规则 | [x] |

### 0.2 PluginContext API 冻结

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 0.2.1 | 冻结 PluginContext 接口定义 | TypeScript 类型文件确定 | [x] |
| 0.2.2 | 冻结 storage/cache API 语义 | 键空间、并发语义、迁移策略明确 | [x] |
| 0.2.3 | 冻结错误类型枚举 | PluginErrorType 完整定义 | [x] |

### 0.3 IPC 契约冻结

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 0.3.1 | 冻结全部 18 个 IPC Commands | 参数/返回类型确定 | [x] |
| 0.3.2 | 冻结 6 个 IPC Events | Payload 结构确定 | [x] |
| 0.3.3 | 生成 TS 类型定义文件 | 前后端共享同一类型源 | [x] |

### 0.4 事件命名规范冻结

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 0.4.1 | 确定三段式/两段式命名规则 | 文档明确，有示例 | [x] |
| 0.4.2 | 定义 action 命名约定 | snake_case，常用动作列表 | [x] |

**Phase 0 验收 Gate**:
- [x] 所有契约文档冻结并 Git Tag (文档已创建，Git Tag 待执行)
- [x] 变更流程已定义（PR + 版本升级）
- [x] TypeScript 类型已从契约自动生成

**Phase 0 完成产物** (2025-12-27):
- `contracts/manifest.schema.json` - manifest.json JSON Schema
- `contracts/api-version-policy.md` - API 版本兼容策略
- `contracts/json-canonical.md` - JSON 规范化规则
- `contracts/storage-cache-api.md` - Storage/Cache API 语义
- `contracts/event-naming.md` - 事件命名规范
- `contracts/types/plugin-context.d.ts` - PluginContext API
- `contracts/types/errors.d.ts` - PluginErrorType 枚举
- `contracts/types/ipc-commands.d.ts` - 18 个 IPC Commands
- `contracts/types/ipc-events.d.ts` - 6 个 IPC Events
- `contracts/types/index.d.ts` - 统一类型导出

---

## 四、Phase 1: 基础设施层

### 1.1 项目脚手架搭建

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 1.1.1 | `pnpm create tauri-app` 初始化 | 命令成功执行 | [x] |
| 1.1.2 | 配置 Tauri 2.0 + Vue 3 + TypeScript | `tauri.conf.json` 正确 | [x] |
| 1.1.3 | 配置 ESLint + Prettier | `eslint.config.js` 存在 | [x] |
| 1.1.4 | 配置 Vitest 测试框架 | `vitest.config.ts` 存在 | [x] |
| 1.1.5 | 配置 Rust 依赖 (Cargo.toml) | 所有依赖版本锁定 | [x] |

**验收标准**: `pnpm tauri dev` 能正常启动空白应用 ✅

### 1.2 类型系统定义

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 1.2.1 | Rust 类型定义 (`src/plugin/types.rs`) | 编译通过 | [x] |
| 1.2.2 | TypeScript 类型定义 (`src/types/`) | 无 `any` 类型 | [x] |
| 1.2.3 | 类型共享机制 (`specta` 或手动同步) | 前后端类型一致 | [x] |

**验收标准**: `cargo check` + `pnpm run typecheck` 无错误 ✅

### 1.3 数据持久化层

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 1.3.1 | 集成 `tauri-plugin-store` | 插件加载成功 | [x] |
| 1.3.2 | 定义存储 Schema | `enabledPlugins`, `pluginConfigs`, `appSettings` | [x] |
| 1.3.3 | 实现 StorageService 封装 | CRUD 操作测试通过 | [x] |
| 1.3.4 | 实现敏感数据 Keychain 存储 | Secret 字段不明文存储 | [x] |

**验收标准**: 单元测试覆盖所有存储操作 ✅

---

## 五、Phase 2: 插件运行时核心

### 2.1 QuickJS 集成

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 2.1.1 | 添加 rquickjs 0.6 依赖 | `Cargo.toml` 配置正确 | [x] |
| 2.1.2 | 实现 `AsyncRuntime` 创建 | 运行时创建成功 | [x] |
| 2.1.3 | 实现 `AsyncContext` 创建 | 上下文创建成功 | [x] |
| 2.1.4 | 配置内存限制 (16MB) | `set_memory_limit` 调用 | [x] |
| 2.1.5 | 配置栈大小限制 (512KB) | `set_max_stack_size` 调用 | [x] |
| 2.1.6 | 实现 `interrupt_handler` | CPU 超时可中断 | [x] |
| 2.1.7 | 实现 watchdog 任务 | 独立于 JS 执行的超时检测 | [x] |

**验收标准**:
- 简单 JS 能在沙盒中执行
- 死循环 JS 能在 30 秒内被中断
- 超内存 JS 能被正确终止

### 2.2 沙盒安全层

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 2.2.1 | 实现 `fetch` API | HTTP/HTTPS 请求成功 | [x] 框架 |
| 2.2.2 | fetch: URL 模式拦截 | localhost/私网 IP 被拒绝 | [x] |
| 2.2.3 | fetch: DNS 级别拦截 | DNS 重绑定攻击被阻止 | [x] |
| 2.2.4 | fetch: 响应大小限制 (10MB) | 超大响应被拒绝 | [x] 框架 |
| 2.2.5 | 实现 `console` API | 日志桥接到 Rust tracing | [x] |
| 2.2.6 | 实现 `TextEncoder/TextDecoder` | 文本编码解码成功 | [~] 待修复生命周期 |
| 2.2.7 | 实现 `atob/btoa` | Base64 编解码成功 | [~] 待修复生命周期 |
| 2.2.8 | 实现 `setTimeout/clearTimeout` | 定时器工作，有数量上限 | [x] 框架 |
| 2.2.9 | 实现 `PluginError` 类注入 | JS 可使用结构化错误 | [x] |
| 2.2.10 | 移除危险全局对象 | eval/Function/WebSocket 不可访问 | [x] |

**验收标准**: 安全测试用例全部通过（尝试访问禁止资源应失败）

### 2.3 生命周期管理

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 2.3.1 | 实现插件发现 | 扫描 `~/.config/cuk/plugins/` | [x] |
| 2.3.2 | 实现 Module 加载 | `declare` + `eval` 模式 | [x] 框架 |
| 2.3.3 | 实现 metadata 解析 | 提取并验证插件元数据 | [x] |
| 2.3.4 | 实现 `onLoad` 生命周期 | 插件加载时调用 | [x] 框架 |
| 2.3.5 | 实现 `onUnload` 生命周期 | 插件卸载时调用 | [x] 框架 |
| 2.3.6 | 实现资源注册表 | 跟踪 timer/subscription/request | [x] |
| 2.3.7 | 实现资源强制回收 | 卸载时取消所有资源 | [x] |
| 2.3.8 | 集成 notify crate | 监听文件变化 | [x] |
| 2.3.9 | 实现热重载逻辑 | 文件变化触发 unload → load | [x] 框架 |

**验收标准**:
- 插件修改后自动重载
- 资源正确释放（无泄漏）
- 热重载期间无重复订阅

### 2.4 安全验证强制点 ⚠️ 与 Phase 5A 集成

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 2.4.1 | 在加载前验证签名 | 签名验证失败则拒绝加载 | [ ] |
| 2.4.2 | 在加载前验证文件哈希 | 哈希不匹配则拒绝加载 | [ ] |
| 2.4.3 | 记录验证日志 | 验证结果可追溯 | [ ] |

**验收标准**: 篡改的插件无法加载，安全日志完整

---

## 六、Phase 3: 可靠性层 ✅

### 3.1 并发调度器

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 3.1.1 | 集成 `futures::stream` | 依赖添加 | [x] |
| 3.1.2 | 实现 `buffer_unordered` 并发 | 多插件并行执行 | [x] |
| 3.1.3 | 实现 `max_concurrent` 配置 | 默认 10，可调整 | [x] |
| 3.1.4 | 实现任务取消机制 | `cancel_flag` 传播 | [x] |
| 3.1.5 | 实现任务队列 | 超并发时排队 | [x] |

**验收标准**: 10 个插件并发执行，超时任务能被取消 ✅

### 3.2 限流器

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 3.2.1 | 集成 `governor` crate | 依赖添加 | [x] |
| 3.2.2 | 实现全局限流 | 总请求数限制 | [x] |
| 3.2.3 | 实现插件级限流 | 每插件独立限流 | [x] |
| 3.2.4 | 实现 `until_ready_with_jitter` | 避免雷暴效应 | [x] |
| 3.2.5 | 实现限流统计 | 记录被限流请求次数 | [x] |

**验收标准**: 超限请求被正确排队/拒绝 ✅

### 3.3 缓存层

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 3.3.1 | 集成 `moka::future::Cache` | 依赖添加 | [x] |
| 3.3.2 | 实现 TTL 过期策略 | 缓存自动过期 | [x] |
| 3.3.3 | 实现 TTI 空闲过期 | 无访问时过期 | [x] |
| 3.3.4 | 实现强制刷新 bypass | `force: true` 绕过缓存 | [x] |
| 3.3.5 | 实现缓存命中率统计 | 可监控 | [x] |

**验收标准**: 缓存命中率可统计，TTL 正确过期 ✅

### 3.4 重试机制

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 3.4.1 | 实现指数退避算法 | 递增重试间隔 | [x] |
| 3.4.2 | 定义可重试错误类型 | NetworkError, Timeout | [x] |
| 3.4.3 | 实现最大重试次数限制 | 默认 3 次 | [x] |
| 3.4.4 | 实现重试统计 | 记录重试次数 | [x] |

**验收标准**: 网络错误自动重试，3 次后放弃 ✅

---

## 七、Phase 4: 通信与配置 ✅

### 4.1 通信总线 ✅

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 4.1.1 | 实现 `context.emit(event, data)` | 事件可发布 | [x] |
| 4.1.2 | 实现 `subscribedEvents` 解析 | 声明式订阅生效 | [x] |
| 4.1.3 | 实现 `onEvent` 回调分发 | 事件路由正确 | [x] |
| 4.1.4 | 实现事件队列 | 异步处理不阻塞 | [x] |

**验收标准**: 跨插件事件能正确传递 ✅ (8 个测试通过)

### 4.2 配置管理 ✅

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 4.2.1 | 实现 `configSchema` 解析 | 自动提取配置定义 | [x] |
| 4.2.2 | 实现配置验证 (`validateConfig`) | 验证失败有错误信息 | [x] |
| 4.2.3 | 实现配置 UI 自动生成 | 根据 schema 渲染表单 | [x] 后端支持 |
| 4.2.4 | 实现配置变更通知 | 配置更新后通知插件 | [x] |

**验收标准**: 配置修改后插件能正确读取 ✅ (9 个测试通过)

### 4.3 权限控制 ✅

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 4.3.1 | 实现 `permissions` 声明解析 | 提取权限列表 | [x] |
| 4.3.2 | 实现 `context.call` 权限检查 | 未授权调用被拒绝 | [x] |
| 4.3.3 | 实现调用深度限制 | 循环调用被阻止 | [x] |
| 4.3.4 | 实现 `exposedMethods` 注册 | 插件方法可被调用 | [x] |

**验收标准**: 未授权调用被拒绝，循环调用检测有效 ✅ (9 个测试通过)

---

## 八、Phase 5A: 安全工具链 (可与 Phase 2 并行) ✅

### 5A.1 签名验证

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 5A.1.1 | 集成 `ed25519-dalek` crate | 依赖添加 | [x] |
| 5A.1.2 | 嵌入公钥到应用二进制 | 编译时内联 | [x] |
| 5A.1.3 | 实现 manifest.json 签名验证 | Ed25519 验证通过 | [x] |
| 5A.1.4 | 实现 JSON 规范化 | 字段排序、编码一致 | [x] |

### 5A.2 完整性校验

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 5A.2.1 | 集成 `sha2` crate | 依赖添加 | [x] |
| 5A.2.2 | 实现文件 SHA256 计算 | 哈希计算正确 | [x] |
| 5A.2.3 | 实现 manifest.files 批量验证 | 所有文件哈希匹配 | [x] |

### 5A.3 安全解压

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 5A.3.1 | 实现路径穿越检测 | 包含 `..` 的路径被拒绝 | [x] |
| 5A.3.2 | 禁止符号链接解压 | symlink 被跳过 | [x] |
| 5A.3.3 | 实现文件大小限制 | 单文件 10MB，总 50MB | [x] |
| 5A.3.4 | 实现文件类型白名单 | 仅 .js/.json/.png/.svg | [x] |
| 5A.3.5 | 实现原子替换 | 临时目录 → 重命名 | [x] |
| 5A.3.6 | 实现备份与回滚 | 保留 N 个历史版本 | [x] |

**验收标准**: 恶意 ZIP 包解压失败，原子替换成功 ✅ (37 个测试全部通过)

---

## 九、Phase 6: 监控层 ✅

### 6.1 健康状态监控

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 6.1.1 | 定义 `PluginHealth` 结构 | 包含所有健康指标 | [x] |
| 6.1.2 | 实现滑动窗口成功率统计 | 最近 N 次调用统计 | [x] |
| 6.1.3 | 实现 healthy/degraded/unhealthy 判定 | 按规则自动判定 | [x] |

### 6.2 调用统计

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 6.2.1 | 实现调用次数统计 | total_calls 准确 | [x] |
| 6.2.2 | 实现成功率统计 | success_rate 准确 | [x] |
| 6.2.3 | 实现延迟统计 (avg/p99) | 滑动窗口计算 | [x] |

### 6.3 告警机制

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 6.3.1 | 实现连续失败告警 | 3 次失败触发通知 | [x] |
| 6.3.2 | 实现高延迟告警 | >5000ms 警告 | [x] |
| 6.3.3 | 实现低成功率告警 | <80% 通知 | [x] |
| 6.3.4 | 集成 tauri-plugin-notification | 系统通知可用 | [x] |

**验收标准**: 插件异常时触发告警 ✅ (2025-12-29)

---

## 十、Phase 7: 平台层 ✅

### 7.1 系统托盘 ✅

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 7.1.1 | 实现托盘图标创建 | 图标显示在菜单栏 | [x] |
| 7.1.2 | 实现动态图标着色 | 根据状态变化颜色 | [x] 框架 |
| 7.1.3 | 实现托盘菜单 | 右键菜单可用 | [x] |
| 7.1.4 | 实现点击事件处理 | 点击打开弹窗 | [x] |

### 7.2 窗口管理 ✅

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 7.2.1 | 实现托盘弹窗 (无边框) | transparent, decorations: false | [x] |
| 7.2.2 | 实现设置窗口 (标准) | resizable, titlebar | [x] |
| 7.2.3 | 实现首次设置向导 | center, modal-like | [x] 框架 |
| 7.2.4 | 实现多窗口状态同步 | Tauri Events 广播 | [x] |

### 7.3 IPC Commands ✅

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 7.3.1 | 实现插件管理 Commands (9个) | plugin_list 等 | [x] |
| 7.3.2 | 实现数据 Commands (4个) | get_all_data 等 | [x] |
| 7.3.3 | 实现配置 Commands (3个) | get_plugin_config 等 | [x] |
| 7.3.4 | 实现监控 Commands (2个) | get_all_health 等 | [x] |
| 7.3.5 | 实现 IPC Events (6个) | ipc:plugin_installed 等 | [x] |

**验收标准**: 前端能调用所有 18 个 API ✅

---

## 十一、Phase 8: 展示层

### 8.1 托盘弹窗 UI ✅

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 8.1.1 | 实现智能头部组件 | Logo + 系统状态 | [x] |
| 8.1.2 | 实现数据卡片动态渲染 | 根据 dataType 选择模板 | [x] |
| 8.1.3 | 实现 usage 卡片模板 | 百分比 + 进度条 + 重置时间 | [x] |
| 8.1.4 | 实现 balance 卡片模板 | 余额 + 货币 + 到期时间 | [x] |
| 8.1.5 | 实现 status 卡片模板 | 状态指示器 + 描述 | [x] |
| 8.1.6 | 实现刷新按钮 | 触发所有插件刷新 | [x] |
| 8.1.7 | 实现设置入口 | 打开设置窗口 | [x] |

### 8.2 设置界面 ✅

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 8.2.1 | 实现插件管理 Tab | 启用/禁用/删除插件 | [x] |
| 8.2.2 | 实现插件配置 Tab | 自动生成配置表单 | [x] |
| 8.2.3 | 实现通知设置 Tab | 告警阈值配置 | [x] |
| 8.2.4 | 实现关于 Tab | 版本/更新检查 | [x] |

### 8.3 仪表盘 ✅

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 8.3.1 | 实现插件列表视图 | 所有已安装插件 | [x] |
| 8.3.2 | 实现数据聚合展示 | 按类型分组 | [x] |
| 8.3.3 | 实现健康状态展示 | 图标 + 状态描述 | [x] |

**验收标准**: UI 完整可用，交互流畅 ✅ (2025-12-29)

---

## 十二、Phase 9: 官方插件

### 9.1 claude-usage.js

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 9.1.1 | 实现 metadata 定义 | 符合规范 | [ ] |
| 9.1.2 | 实现组织 ID 获取 | 首次缓存 | [ ] |
| 9.1.3 | 实现使用量数据获取 | 解析所有字段 | [ ] |
| 9.1.4 | 实现 UsageData 返回 | 包含 dimensions | [ ] |
| 9.1.5 | 实现阈值超限事件发布 | 75%/95% 阈值 | [ ] |
| 9.1.6 | 实现会话重置事件发布 | 0% 时触发 | [ ] |

### 9.2 claude-status.js

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 9.2.1 | 实现 statuspage.io 状态获取 | 10 秒超时 | [ ] |
| 9.2.2 | 实现 StatusData 返回 | indicator + description | [ ] |
| 9.2.3 | 实现状态变化事件发布 | status_changed | [ ] |

### 9.3 claude-balance.js

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 9.3.1 | 实现超额消费限额获取 | overage_spend_limit API | [ ] |
| 9.3.2 | 实现 BalanceData 返回 | balance + currency | [ ] |

### 9.4 notifications.js

| 任务 ID | 任务描述 | 验收标准 | 状态 |
|---------|----------|----------|------|
| 9.4.1 | 实现 subscribedEvents 定义 | 订阅所有告警事件 | [ ] |
| 9.4.2 | 实现 onEvent 处理 | 调用系统通知 | [ ] |
| 9.4.3 | 实现 exposedMethods.send | 供其他插件调用 | [ ] |

**验收标准**: 插件功能正常，数据正确，事件通信正常

---

## 十三、技术依赖配置

### Rust 依赖 (Cargo.toml)

```toml
[dependencies]
# Tauri 核心
tauri = { version = "2.2", features = ["tray-icon", "native-dialog"] }
tauri-plugin-store = "2.0"
tauri-plugin-notification = "2.0"

# QuickJS 运行时 (⚠️ 不启用 allocator feature)
rquickjs = { version = "0.6", features = [
    "bindgen", "classes", "loader", "futures", "parallel"
] }

# 异步运行时
tokio = { version = "1", features = ["rt-multi-thread", "sync", "time", "macros"] }
futures = "0.3"

# HTTP
reqwest = { version = "0.12", features = ["json", "rustls-tls"], default-features = false }

# 限流
governor = "0.6"

# 缓存
moka = { version = "0.12", features = ["future"] }

# 序列化
serde = { version = "1", features = ["derive"] }
serde_json = "1"

# 时间
chrono = { version = "0.4", features = ["serde"] }

# 签名验证
ed25519-dalek = "2.0"
sha2 = "0.10"

# 日志
tracing = "0.1"
tracing-subscriber = "0.3"

# 文件监听
notify = "6.1"
```

### Vue 前端依赖 (package.json)

```json
{
  "dependencies": {
    "vue": "^3.5",
    "@tauri-apps/api": "^2.0",
    "@tauri-apps/plugin-store": "^2.0",
    "pinia": "^2.2",
    "lucide-vue-next": "^0.460"
  },
  "devDependencies": {
    "typescript": "^5.7",
    "vite": "^6.0",
    "@vitejs/plugin-vue": "^5.2",
    "vitest": "^2.1"
  }
}
```

---

## 十四、风险矩阵与缓解策略

| 风险 | 等级 | 影响 | 缓解策略 |
|------|------|------|----------|
| QuickJS interrupt_handler 无法中断阻塞型宿主函数 | 高 | 死循环无法停止 | 所有宿主函数使用 async + timeout |
| DNS 重绑定攻击绕过网络限制 | 高 | 内网渗透 | 双层防护：URL 模式 + DNS 级别检查 |
| 热重载资源泄漏 | 中 | 内存泄漏/重复订阅 | 资源注册表 + 强制回收机制 |
| 签名验证时机错误 | 中 | 恶意代码执行 | 严格顺序：验签 → 验哈希 → 加载 |
| rquickjs allocator feature 导致内存限制失效 | 中 | OOM 风险 | 确保不启用 allocator feature |
| Tauri 2.0 tray API 不稳定 | 低 | 功能受限 | 早期验证，准备降级方案 |

---

## 十五、里程碑与验收 Gate

| 里程碑 | 完成 Phase | 验收条件 | 状态 |
|--------|------------|----------|------|
| M0: 契约冻结 | Phase 0 | 所有接口定义 Git Tag | [x] ✅ 2025-12-27 |
| M1: 空白应用 | Phase 1 | `tauri dev` 启动成功 | [x] ✅ 2025-12-28 |
| M2: 沙盒执行 | Phase 2 | JS 插件可在沙盒中执行 | [~] 框架完成，待修复生命周期 |
| M3: 可靠运行 | Phase 3-4 | 插件并发可靠执行 | [~] Phase 3 完成 ✅ 2025-12-28 |
| M4: 完整应用 | Phase 5-8 | UI 可用，安全机制完整 | [x] ✅ 2025-12-29 |
| M5: 产品就绪 | Phase 9 | 官方插件功能正常 | [ ] |

---

## 十六、并行执行建议

```
开发者 A (Rust 后端)          │ 开发者 B (Rust 安全)        │ 开发者 C (Vue 前端)
───────────────────────────────────────────────────────────────────────────────
Phase 0: 契约冻结 (协作)      │ Phase 0: 契约冻结 (协作)    │ Phase 0: 契约冻结 (协作)
    ↓                         │     ↓                       │     ↓
Phase 1: 基础设施             │                             │
    ↓                         │                             │
Phase 2: 插件运行时           │ Phase 5A: 安全工具链        │ Phase 1.2: TS 类型
    ↓                         │     ↓                       │     ↓
Phase 3: 可靠性层             │                             │ Phase 7.3: IPC 类型
    ↓                         │                             │     ↓
Phase 4: 通信配置             │                             │ Phase 8: 展示层
    ↓                         │                             │
Phase 6: 监控层               │                             │
    ↓                         │                             │
Phase 7: 平台层               │                             │
    ↓                         │                             │
Phase 9: 官方插件 (协作)      │                             │ Phase 9: 官方插件 (协作)
```

---

## 十七、审核意见整合 (Codex gpt-5.2 + xhigh)

### 评分: 78/100

### 关键改进点 (已纳入)

1. **新增 Phase 0: 契约冻结** - 作为所有 Phase 的合流点
2. **安全验证强制点** - 从 Phase 5 拆分到 Phase 2.4，确保"先验证再加载"
3. **资源注册表** - 新增 2.3.6-2.3.7，解决热重载资源泄漏问题
4. **JSON 规范化** - 新增 5A.1.4，确保签名可重现
5. **垂直切片验证** - 建议尽早完成端到端闭环

### 待评估项

- cache/storage API 的完整实现规格
- apiVersion 降级行为的具体策略
- 跨插件调用的深度限制具体值

---

**文档版本**: v1.7
**创建时间**: 2025-12-27
**更新时间**: 2025-12-29
**审核工具**: Codex (gpt-5.2 + xhigh reasoning)
**任务总数**: 120+ 项
**预计并行开发人数**: 2-3 人
**Phase 4 完成时间**: 2025-12-29
**Phase 6 完成时间**: 2025-12-29
**Phase 7 完成时间**: 2025-12-28
**Phase 8 完成时间**: 2025-12-29

---

## 下一步行动

> **当前阶段**: Phase 8 展示层全部完成 → 进入 Phase 9 官方插件

### Phase 3 完成产物 (2025-12-28)

**3.1 并发调度器** ✅
- `src-tauri/src/reliability/scheduler.rs` - 任务调度器
  - TaskScheduler 多任务并发执行
  - 优先级队列（Low/Normal/High/Critical）
  - 任务取消机制（CancellationToken）
  - 队列满拒绝策略
  - 统计信息（提交/完成/取消/超时）

**3.2 限流器** ✅
- `src-tauri/src/reliability/rate_limiter.rs` - 令牌桶限流
  - governor crate 集成
  - 全局限流（100 req/s）
  - 插件级限流（20 req/s per plugin）
  - Jitter 避免雷暴效应
  - 限流统计

**3.3 缓存层** ✅
- `src-tauri/src/reliability/cache.rs` - 异步缓存
  - moka::future::Cache 集成
  - TTL 过期（默认 5 分钟）
  - TTI 空闲过期（默认 2 分钟）
  - 强制刷新 bypass
  - 缓存命中率统计

**3.4 重试机制** ✅
- `src-tauri/src/reliability/retry.rs` - 指数退避重试
  - 指数退避算法（multiplier=2.0）
  - 可重试错误类型判断
  - 最大重试次数（默认 3）
  - Jitter 随机延迟
  - 重试统计

**测试覆盖**
- 37 个单元测试全部通过
- 集成测试验证组件协同

### Phase 7 完成产物 (2025-12-28)

**7.1 系统托盘** ✅
- `src-tauri/src/tray/mod.rs` - 托盘管理
  - TrayIcon 创建和管理
  - TrayMenu 右键菜单
  - 点击事件处理（左键切换弹窗，右键菜单）
  - 动态状态更新（工具提示）

**7.2 窗口管理** ✅
- `src-tauri/src/window/mod.rs` - 窗口管理器
  - 托盘弹窗（无边框、透明）
  - 设置窗口（标准窗口）
  - 首次设置向导（框架）
  - 多窗口状态同步（Tauri Events）

**7.3 IPC Commands** ✅
- `src-tauri/src/commands/ipc.rs` - 18 个 IPC Commands
  - 插件管理 Commands (9个)
  - 数据 Commands (4个)
  - 配置 Commands (3个)
  - 监控 Commands (2个)
- `src-tauri/src/commands/events.rs` - 6 个 IPC Events

**配置更新**
- `tauri.conf.json` - 托盘弹窗配置（无边框、透明、始终置顶）

### Phase 6 完成产物 (2025-12-29)

**6.1 健康状态监控** ✅
- `src-tauri/src/plugin/types.rs` - PluginHealth 结构增强
  - 新增 p99_latency_ms（P99 延迟）
  - 新增 consecutive_failures（连续失败次数）
  - 新增 total_calls（总调用次数）

**6.1.2 滑动窗口统计** ✅
- `src-tauri/src/plugin/monitoring/sliding_window.rs` - 滑动窗口实现
  - 环形缓冲区存储最近 N 次调用（默认 100）
  - 成功率计算
  - 平均延迟计算
  - P99 延迟计算
  - 完整单元测试覆盖

**6.1.3 健康状态判定** ✅
- `src-tauri/src/plugin/lifecycle.rs` - to_health() 增强
  - 连续失败 >= 3 → Unhealthy
  - 成功率 < 80% → Unhealthy
  - 成功率 80%-95% → Degraded
  - 成功率 >= 95% 且连续失败 < 3 → Healthy

**6.2 调用统计** ✅
- `src-tauri/src/plugin/lifecycle.rs` - PluginInstance 增强
  - sliding_window 字段集成
  - consecutive_failures 连续失败计数
  - total_calls 总调用次数
  - record_success/record_failure 方法更新

**6.3 告警机制** ✅
- `src-tauri/src/plugin/monitoring/alert.rs` - 告警管理器
  - AlertManager 告警管理
  - 连续失败告警（3 次触发）
  - 高延迟告警（>5000ms）
  - 低成功率告警（<80%）
  - 告警冷却机制（防止告警风暴）
  - 告警历史记录
  - 告警统计

**6.3.4 通知集成** ✅
- `src-tauri/src/plugin/monitoring/notification.rs` - Tauri 通知集成
  - TauriNotificationHandler 实现
  - NotificationHandler trait 解耦
  - create_alert_manager_with_notifications 便捷函数

**模块导出** ✅
- `src-tauri/src/plugin/monitoring/mod.rs` - 监控模块入口
- `src-tauri/src/plugin/mod.rs` - 监控层导出

### Phase 4 完成产物 (2025-12-29)

**4.1 通信总线** ✅
- `src-tauri/src/plugin/event_bus.rs` - 事件总线
  - EventBus 发布/订阅机制
  - QueuedEvent 事件队列
  - 事件命名验证（三段式/两段式）
  - 异步事件分发（tokio::mpsc）
  - 订阅管理（subscribe/unsubscribe_all）
  - 事件处理器注册
  - 8 个单元测试全部通过

**4.2 配置管理** ✅
- `src-tauri/src/plugin/config.rs` - 配置管理器
  - ConfigSchema 类型定义
  - ConfigField 字段定义（string/number/boolean/select）
  - 配置验证（类型检查、范围检查、选项检查）
  - 配置默认值合并
  - 配置变更通知（通过事件总线）
  - 敏感字段识别
  - 9 个单元测试全部通过

**4.3 权限控制** ✅
- `src-tauri/src/plugin/permission.rs` - 权限控制器
  - Permission 权限类型定义（Call/Network/Timer/Storage/Cache）
  - PermissionChecker 权限检查器
  - CallStack 调用栈追踪（循环调用检测）
  - MethodRegistry 方法注册表
  - 调用深度限制（默认 3 层）
  - 9 个单元测试全部通过

**PluginManifest 更新**
- `src-tauri/src/plugin/lifecycle.rs` - 新增字段
  - `config_schema: Option<serde_json::Value>` - 配置 Schema
  - `exposed_methods: Vec<String>` - 暴露的方法列表

**模块导出**
- `src-tauri/src/plugin/mod.rs` - Phase 4 模块导出
  - 事件总线：EventBus, EventBusConfig, QueuedEvent 等
  - 配置管理：ConfigManager, ConfigField, ConfigSchema 等
  - 权限控制：PermissionChecker, CallStack, MethodRegistry 等

### Phase 8.1 完成产物 (2025-12-29)

**8.1.1 TrayHeader 头部组件** ✅
- `src/components/tray/TrayHeader.vue` - 托盘弹窗头部
  - Logo 图标 + "AI Tracker" 标题
  - 系统状态指示器（绿/橙/红点）
  - Core Runtime 版本显示
  - 刷新按钮（支持加载动画）
  - 设置按钮

**8.1.2-8.1.3 UsageCard 使用量卡片** ✅
- `src/components/tray/UsageCard.vue` - 使用量数据展示
  - 大字号百分比显示
  - 进度条（颜色随使用率变化）
  - 重置时间倒计时
  - 流量状态标签（Low/Moderate/High/Critical）
  - 插件标签显示

**8.1.4 BalanceCard 余额卡片** ✅
- `src/components/tray/BalanceCard.vue` - API 余额展示
  - 余额数字格式化（支持 USD/CNY/EUR 等）
  - API 状态指示器
  - 颜色主题支持（green/blue/orange/purple）
  - 健康状态显示

**8.1.5 StatusCard 状态卡片** ✅
- `src/components/tray/StatusCard.vue` - 系统状态展示
  - 状态指示器（none/minor/major/critical）
  - 监控插件数量显示
  - 可展开交互支持

**8.1.6-8.1.7 PluginBar 底部栏** ✅
- `src/components/tray/PluginBar.vue` - 插件管理入口
  - 插件头像列表（首字母 + 颜色）
  - 更多插件指示（...）
  - "Manage Plugins" 按钮

**HomeView 重构** ✅
- `src/views/HomeView.vue` - 托盘弹窗主视图
  - 集成所有卡片组件
  - IPC 数据加载（plugin_list, get_all_data, get_all_health）
  - 刷新功能（refresh_all）
  - 事件监听（plugin_data_updated, plugin_health_changed）
  - 空状态示例数据展示

**组件导出** ✅
- `src/components/tray/index.ts` - 托盘组件导出
- `src/components/index.ts` - 组件根导出

**验证通过**
- `pnpm run typecheck` 无错误

### Phase 8.2/8.3 完成产物 (2025-12-29)

**布局组件** ✅
- `src/components/layout/AppLayout.vue` - 主应用布局
  - 侧边栏 + 主内容区结构
  - 顶部状态栏（守护进程状态、通知按钮）
  - 页面标题插槽
- `src/components/layout/AppSidebar.vue` - 侧边栏导航
  - 应用标题和 Logo
  - 菜单导航（仪表盘、我的插件、插件市场）
  - 系统菜单（运行日志、全局设置）
  - 用户信息区域

**仪表盘页面** ✅
- `src/views/DashboardView.vue` - 仪表盘视图
  - 主插件卡片展示
  - 使用量百分比大字号显示
  - 进度条（颜色随使用率变化）
  - 重置时间倒计时
  - 多维度限额详情（5小时会话、每日总上限）
  - 连接监控区域

**我的插件页面** ✅
- `src/views/PluginsView.vue` - 插件管理视图
  - 统计概览（插件总数、系统健康度、总调用量）
  - 已安装插件列表
  - 插件启用/禁用开关
  - 调用次数、成功率、延迟统计
  - 健康状态标签

**插件市场页面** ✅
- `src/views/MarketplaceView.vue` - 插件市场视图
  - 搜索框
  - 热门推荐插件
  - 插件卡片（名称、描述、下载量、版本）
  - 下载按钮

**全局设置页面** ✅
- `src/views/SettingsView.vue` - 设置视图（重写）
  - 面包屑导航
  - 插件配置表单
  - 会话密钥输入（已加密标识）
  - 刷新间隔滑块
  - 后台监控开关
  - 恢复默认/保存修改按钮

**运行日志页面** ✅
- `src/views/LogsView.vue` - 日志视图
  - 级别过滤（info/warn/error/debug）
  - 插件过滤
  - 搜索功能
  - 日志列表（monospace 字体）
  - 导出/清空按钮

**状态管理** ✅
- `src/stores/plugin.ts` - 插件状态 Store
  - 插件列表、数据、健康状态管理
  - IPC 调用封装
  - 计算属性（enabledPlugins、systemHealthRate 等）
- `src/stores/app.ts` - 应用状态 Store
  - 应用设置管理
  - 守护进程状态
  - 当前路由

**路由更新** ✅
- `src/router/index.ts` - 新路由结构
  - `/dashboard` - 仪表盘（默认）
  - `/plugins` - 我的插件
  - `/marketplace` - 插件市场
  - `/logs` - 运行日志
  - `/settings` - 全局设置
  - 旧路由兼容重定向

**样式更新** ✅
- `src/styles/main.css` - 全局样式增强
  - 深色主题颜色变量
  - 侧边栏样式变量
  - 浅色主题 media query 支持

### 待完成任务

**Phase 2 待修复**:
- `encoding.rs` 中闭包返回 Object 生命周期问题

**Phase 9 待实现**:
- 官方插件（claude-usage.js、claude-status.js、notifications.js）

### 即将执行

| 优先级 | 任务 | 说明 |
|--------|------|------|
| P0 | Phase 9 官方插件 | claude-usage.js、claude-status.js 等 |
| ~P0~ | ~Phase 8.2 设置界面~ | ✅ 已完成 (2025-12-29) |
| ~P0~ | ~Phase 8.3 仪表盘~ | ✅ 已完成 (2025-12-29) |
| ~P0~ | ~Phase 8.1 托盘弹窗 UI~ | ✅ 已完成 (2025-12-29) |
| ~P0~ | ~Phase 4 通信与配置~ | ✅ 已完成 (2025-12-29) |
| ~P2~ | ~Phase 6 监控层~ | ✅ 已完成 (2025-12-29) |

### 验收标准

- [x] `pnpm tauri dev` 能正常启动空白应用
- [x] `cargo check` 无错误
- [x] `pnpm run typecheck` 无错误
- [x] Phase 5A 安全工具链测试通过 (37/37)
- [x] Phase 7 平台层编译通过
- [x] Phase 3 可靠性层测试通过 (37/37)
- [x] Phase 6 监控层编译通过 (2025-12-29)
- [x] Phase 4 通信与配置测试通过 (26/26) (2025-12-29)
- [x] Phase 8.1 托盘弹窗 UI 组件完成 (2025-12-29)
- [x] Phase 8.2 设置界面完成 (2025-12-29)
- [x] Phase 8.3 仪表盘完成 (2025-12-29)
- [ ] 托盘点击能正常显示/隐藏弹窗 (待运行测试)
- [ ] 前端能调用所有 18 个 IPC API (待集成测试)

---

## 参考资源

- [Tauri 2.0 Plugin Development](https://v2.tauri.app/develop/plugins/)
- [Tauri 2.0 Capabilities](https://v2.tauri.app/security/capabilities/)
- [rquickjs Documentation](https://docs.rs/rquickjs/latest/rquickjs/)
- [Governor Rate Limiter](https://docs.rs/governor/latest/governor/)
- [Moka Cache](https://github.com/moka-rs/moka)

# AI 使用量追踪器 - 全外置插件架构功能清单

> **架构理念**: 应用核心只是插件运行时，所有功能都是可热更新的外置插件
> **核心优势**: API 变化时只需更新插件，无需发布新应用
> **版本**: v2.2 (All-External Plugin Architecture)
> **审核状态**: 已通过 Codex (gpt-5.2 xhigh) 二次审核并修正

---

## 一、项目概述

| 属性 | 描述 |
|------|------|
| **类型** | macOS 跨平台菜单栏应用 |
| **架构模式** | **全外置插件 (All-External Plugins)** |
| **核心理念** | 应用核心 = 纯运行时，所有功能 = 外置插件 |
| **技术栈** | Rust + Tauri 2.0 / Vue 3.x (TypeScript) |
| **插件运行时** | QuickJS (所有插件统一使用 JS) |

### 1.1 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                 应用核心（极少更新）                      │
│  纯粹的插件运行时，不包含任何业务逻辑                      │
├─────────────────────────────────────────────────────────┤
│  插件运行时 │ 生命周期管理 │ 通信总线 │ 配置管理          │
├─────────────────────────────────────────────────────────┤
│              运行时可靠性层（并发/限流/缓存）              │
├─────────────────────────────────────────────────────────┤
│                   监控层 + 展示层                        │
│           收集插件数据 → 统一仪表盘展示                   │
├─────────────────────────────────────────────────────────┤
│                   平台层                                 │
│           系统托盘 │ 窗口管理 │ 数据持久化               │
└─────────────────────────────────────────────────────────┘
                          ▲
                          │ 加载
┌─────────────────────────┴───────────────────────────────┐
│              外置插件（可热更新）                         │
│         ~/.config/cuk/plugins/                          │
├─────────────────────────────────────────────────────────┤
│  官方插件                                                │
│  ├── claude-usage.js      # Claude 使用量监控           │
│  ├── claude-status.js     # Claude 系统状态             │
│  ├── claude-balance.js    # Claude Extra 费用           │
│  └── notifications.js     # 通知规则引擎                │
├─────────────────────────────────────────────────────────┤
│  第三方插件                                              │
│  ├── openai-balance.js    # OpenAI 余额                 │
│  ├── deepseek-balance.js  # DeepSeek 余额               │
│  └── ...                                                │
└─────────────────────────────────────────────────────────┘
```

### 1.2 核心优势

| 优势 | 说明 |
|------|------|
| **快速响应 API 变化** | Claude API 变化时，更新插件即可，无需发布新应用 |
| **热更新** | 插件更新后立即生效，无需重启应用 |
| **用户可定制** | 用户可以修改/创建自己的插件 |
| **应用核心稳定** | 核心代码极少变化，降低维护成本 |
| **社区驱动** | 社区可以贡献新的中转站插件 |

---

## 二、应用核心 (Application Core)

> 纯粹的运行时基础设施，不包含任何业务逻辑

### 2.1 插件运行时 (PluginRuntime)

| 功能点 | 描述 | 状态 |
|--------|------|------|
| QuickJS 集成 | 轻量级 JS 引擎 (rquickjs 0.6) | [ ] |
| 多实例隔离 | 每个插件独立运行时 | [ ] |
| 内存限制 | 单插件 16MB 限制 | [ ] |
| CPU 限制 | 中断处理器防死循环 | [ ] |
| 超时控制 | 30 秒执行超时 | [ ] |
| ESM 模块支持 | 支持 ES Module 语法 | [ ] |
| 异步取消 | 支持取消 in-flight fetch | [ ] |

### 2.2 插件生命周期管理 (PluginLifecycle)

| 功能点 | 描述 | 状态 |
|--------|------|------|
| 插件发现 | 扫描 `~/.config/cuk/plugins/` | [ ] |
| 插件加载 | 解析 metadata + 初始化 | [ ] |
| 插件卸载 | 安全释放资源，调用 onUnload | [ ] |
| 热重载 | 文件变化时自动重载 | [ ] |
| 依赖检查 | API 版本兼容性 | [ ] |
| 资源回收 | 卸载时取消所有 pending 请求 | [ ] |

### 2.3 运行时可靠性层 (Reliability Layer)

> 从旧插件系统设计文档迁移，确保运行时可控

#### 2.3.1 并发调度器 (ConcurrencyScheduler)

| 功能点 | 描述 | 状态 |
|--------|------|------|
| 并行查询 | 多插件同时发起查询 | [ ] |
| 任务队列 | 管理待执行的查询任务 | [ ] |
| 并发限制 | 可配置最大并发数（默认 10） | [ ] |
| 超时控制 | 单个插件执行超时设置 | [ ] |
| 任务取消 | 支持取消正在执行的任务 | [ ] |

#### 2.3.2 限流器 (RateLimiter)

| 功能点 | 描述 | 状态 |
|--------|------|------|
| 全局限流 | 总请求数限制 | [ ] |
| 插件级限流 | 每个插件独立限流 | [ ] |
| 滑动窗口 | 基于时间窗口的限流 | [ ] |
| 退避策略 | 被限流时的退避等待 | [ ] |

#### 2.3.3 缓存层 (CacheLayer)

| 功能点 | 描述 | 状态 |
|--------|------|------|
| LRU 缓存 | 最近最少使用淘汰 | [ ] |
| TTL 过期 | 可配置过期时间 | [ ] |
| 缓存命中 | 减少重复请求 | [ ] |
| 强制刷新 | 绕过缓存获取最新数据 | [ ] |

#### 2.3.4 重试机制 (RetryPolicy)

| 功能点 | 描述 | 状态 |
|--------|------|------|
| 自动重试 | 失败后自动重试 | [ ] |
| 指数退避 | 递增重试间隔 | [ ] |
| 最大重试次数 | 可配置（默认 3 次） | [ ] |
| 可重试错误 | 仅网络错误/超时可重试 | [ ] |

### 2.4 插件通信总线 (PluginBus)

> 统一使用声明式事件订阅模型

| 功能点 | 描述 | 状态 |
|--------|------|------|
| 事件发布 | `context.emit(event, data)` | [ ] |
| 声明式订阅 | 插件通过 `subscribedEvents` 数组声明 | [ ] |
| 事件回调 | 通过 `onEvent(event, data, context)` 处理 | [ ] |
| 跨插件调用 | `context.call(pluginId, method, args)` | [ ] |
| 权限控制 | 跨插件调用需声明 `permissions` | [ ] |

#### 事件命名规范

> 采用分层命名：**三段式**用于插件事件，**两段式**用于系统/IPC事件

| 事件类型 | 命名格式 | 说明 | 示例 |
|----------|----------|------|------|
| 插件事件 | `plugin:{plugin_id}:{action}` | 三段式，包含插件标识 | `plugin:claude-usage:data_updated` |
| 系统事件 | `system:{action}` | 两段式，全局系统操作 | `system:refresh_all` |
| IPC 事件 | `ipc:{action}` | 两段式，前后端通信 | `ipc:plugin_installed` |

**命名规则说明**：
- **插件事件**（三段式）：插件之间的通信，必须包含 `plugin_id` 以明确来源
- **系统事件**（两段式）：应用核心发出的全局事件，无需插件标识
- **IPC 事件**（两段式）：Rust 后端与 Vue 前端的通信，无需插件标识

**action 命名约定**：
- 使用 `snake_case` 格式
- 常用动作：`data_updated`, `threshold_exceeded`, `session_reset`, `health_changed`

### 2.5 配置管理 (ConfigManager)

| 功能点 | 描述 | 状态 |
|--------|------|------|
| Schema 解析 | 读取插件 configSchema | [ ] |
| 配置验证 | 自动验证用户输入 | [ ] |
| 配置存储 | 持久化到本地 | [ ] |
| 配置 UI | 自动生成设置界面 | [ ] |

### 2.6 注入 API (Injected APIs)

> 应用核心向插件注入的安全 API

| API | 描述 | 状态 |
|-----|------|------|
| `fetch(url, options)` | HTTP 请求（仅 HTTPS，禁止本地网络） | [ ] |
| `console.*` | 日志输出 | [ ] |
| `TextEncoder/Decoder` | 文本编码 | [ ] |
| `atob/btoa` | Base64 | [ ] |
| `setTimeout/clearTimeout` | 定时器 | [ ] |
| `context.config` | 获取插件配置 | [ ] |
| `context.storage` | 插件专属存储 | [ ] |
| `context.emit(event, data)` | 发布事件 | [ ] |
| `context.call(pluginId, method, args)` | 跨插件调用 | [ ] |
| `context.log(level, msg)` | 日志 | [ ] |
| `context.cache` | 缓存 API | [ ] |

---

## 三、监控层 (Monitoring Layer)

> 横切关注点：监控所有插件的健康状态

### 3.1 插件健康监控

| 指标 | 描述 | 状态 |
|------|------|------|
| `health_status` | healthy / degraded / unhealthy | [ ] |
| `last_success` | 最后成功时间 | [ ] |
| `last_error` | 最后错误信息 | [ ] |
| `error_count` | 错误计数 | [ ] |

#### 健康状态判定规则

| 状态 | 条件 |
|------|------|
| `healthy` | 最近 3 次调用全部成功 |
| `degraded` | 最近 3 次调用有 1-2 次失败 |
| `unhealthy` | 最近 3 次调用全部失败 |

### 3.2 调用统计

| 指标 | 描述 | 采集方式 | 状态 |
|------|------|----------|------|
| `total_calls` | 总调用次数 | 每次 fetchData 调用 +1 | [ ] |
| `success_count` | 成功次数 | fetchData 返回成功 +1 | [ ] |
| `success_rate` | 成功率 | success_count / total_calls | [ ] |
| `avg_latency_ms` | 平均延迟 | 滑动窗口平均值 | [ ] |
| `p99_latency_ms` | P99 延迟 | 百分位统计 | [ ] |

### 3.3 告警机制

| 规则 | 条件 | 动作 |
|------|------|------|
| 插件故障 | 连续 3 次失败 | 系统通知 |
| 高延迟 | avg_latency_ms > 5000 | 日志警告 |
| 插件崩溃 | 运行时异常 | 自动重启 + 通知 |
| 低成功率 | success_rate < 0.8 | 系统通知 |

---

## 四、展示层 (Display Layer)

> 统一展示所有插件数据

### 4.1 托盘弹窗 (TrayPopover)

| 组件 | 数据来源 | 描述 |
|------|----------|------|
| 智能头部 | `claude-status` 插件 | Logo + 系统状态 |
| 数据卡片列表 | 所有启用的 DataPlugin | 动态渲染插件返回的数据 |
| 刷新按钮 | - | 触发所有插件刷新 |
| 设置入口 | - | 打开设置窗口 |

#### 卡片渲染逻辑

```typescript
// 根据插件返回的 dataType 自动选择卡片模板
interface PluginData {
  dataType: 'usage' | 'balance' | 'status' | 'custom';
  // ...
}

// usage 类型 → 使用量卡片（百分比 + 进度条 + 重置时间）
// balance 类型 → 余额卡片（余额 + 货币 + 到期时间）
// status 类型 → 状态卡片（状态指示器 + 描述）
// custom 类型 → 使用插件提供的 renderHtml 自定义渲染
```

### 4.2 统一仪表盘 (Dashboard)

| 功能 | 描述 |
|------|------|
| 插件列表 | 所有已安装插件 |
| 数据聚合 | 按类型分组展示 |
| 历史图表 | 数据变化趋势 |
| 批量刷新 | 一键刷新所有插件 |

### 4.3 设置界面 (Settings)

| Tab | 描述 |
|-----|------|
| 插件管理 | 启用/禁用/删除插件 |
| 插件配置 | 各插件的配置表单（自动生成） |
| 插件市场 | 浏览/安装官方和社区插件 |
| 通知设置 | 告警阈值配置 |
| 关于 | 版本/更新检查 |

---

## 五、平台层 (Platform Layer)

### 5.1 系统托盘

| 功能点 | 描述 |
|--------|------|
| 动态图标 | 根据插件状态着色 |
| 颜色编码 | 绿（正常）/ 橙（警告）/ 红（异常） |
| 点击弹窗 | 显示 TrayPopover |

### 5.2 窗口管理

| 窗口 | 类型 | 触发 |
|------|------|------|
| 托盘弹窗 | 无边框 | 点击托盘图标 |
| 设置窗口 | 标准 | 点击设置按钮 |
| 设置向导 | 标准 | 首次启动 |

### 5.3 数据持久化

| 存储项 | 描述 |
|--------|------|
| `enabledPlugins` | 启用的插件列表 |
| `pluginConfigs` | 各插件配置 |
| `pluginCache` | 插件数据缓存 |
| `appSettings` | 应用设置 |

---

## 六、插件规范 (Plugin Specification)

> 所有插件（包括官方插件）都遵循此规范

### 6.1 插件类型分类

> 解决 fetchData 契约矛盾问题

| 插件类型 | 必须实现 | 说明 |
|----------|----------|------|
| **DataPlugin** | `fetchData()` | 返回数据供展示层渲染 |
| **EventPlugin** | `onEvent()` | 只处理事件，不返回数据 |
| **HybridPlugin** | 两者都实现 | 既返回数据又处理事件 |

```javascript
// 通过 metadata.pluginType 声明类型
export const metadata = {
  pluginType: "data",   // "data" | "event" | "hybrid"
  // ...
};
```

### 6.2 插件文件结构

```
~/.config/cuk/plugins/
├── claude-usage/
│   ├── plugin.js       # 插件主文件
│   ├── manifest.json   # 元数据（可选，也可在 JS 中导出）
│   └── icon.png        # 图标（可选）
├── openai-balance/
│   ├── plugin.js
│   └── icon.png
└── ...
```

### 6.3 插件 API 规范

```javascript
// ========== 必须导出 ==========

/**
 * 插件元数据
 */
export const metadata = {
  // === 必填字段 ===
  id: "claude-usage",              // 唯一标识
  name: "Claude 使用量",            // 显示名称
  version: "1.0.0",                // 语义化版本
  apiVersion: "1.0",               // API 兼容版本
  pluginType: "data",              // 插件类型: "data" | "event" | "hybrid"

  // === DataPlugin 必填 ===
  dataType: "usage",               // usage | balance | status | custom

  // === 可选字段 ===
  author: "CUK Team",
  description: "监控 Claude Pro 使用量",
  homepage: "https://github.com/...",
  icon: "icon.png",

  // === 刷新策略（单位统一为毫秒）===
  refreshIntervalMs: 30000,        // 自动刷新间隔 (ms)，0 = 手动刷新

  // === 权限声明（跨插件调用需要）===
  permissions: [
    "call:notifications:send"      // 允许调用 notifications 插件的 send 方法
  ],

  // === 配置项声明 ===
  configSchema: {
    sessionKey: {
      type: "string",
      required: true,
      secret: true,
      label: "Session Key",
      description: "从浏览器获取的 sessionKey"
    },
    refreshIntervalMs: {
      type: "number",
      default: 30000,              // 统一使用毫秒
      min: 5000,
      max: 120000,
      label: "刷新间隔（毫秒）"
    }
  }
};

/**
 * 获取数据（DataPlugin / HybridPlugin 必须实现）
 * @param {Object} config - 用户配置
 * @param {PluginContext} context - 运行时上下文
 * @returns {Promise<PluginData>}
 */
export async function fetchData(config, context) {
  // 实现数据获取逻辑
  // 返回符合 dataType 的数据结构
}

// ========== EventPlugin 必须导出 ==========

/**
 * 订阅的事件列表
 */
export const subscribedEvents = [
  'plugin:claude-usage:data_updated',
  'plugin:claude-usage:threshold_exceeded',
];

/**
 * 事件处理函数（EventPlugin / HybridPlugin 必须实现）
 * @param {string} event - 事件名
 * @param {any} data - 事件数据
 * @param {PluginContext} context - 运行时上下文
 */
export async function onEvent(event, data, context) {
  switch (event) {
    case 'plugin:claude-usage:data_updated':
      // 处理使用量更新事件
      break;
    case 'plugin:claude-usage:threshold_exceeded':
      // 处理阈值超限事件
      await context.call('notifications', 'send', {
        title: '使用量告警',
        body: `当前使用量: ${data.percentage}%`
      });
      break;
  }
}

// ========== 可选导出 ==========

/**
 * 插件加载时调用
 */
export async function onLoad(context) {
  context.log('info', 'Plugin loaded');
}

/**
 * 插件卸载时调用
 */
export async function onUnload(context) {
  context.log('info', 'Plugin unloaded');
}

/**
 * 验证配置
 */
export async function validateConfig(config) {
  if (!config.sessionKey?.startsWith('sk-ant-')) {
    return { valid: false, message: "Session Key 格式不正确" };
  }
  return { valid: true };
}

/**
 * 暴露给其他插件调用的方法（需在 permissions 中声明）
 */
export const exposedMethods = {
  async send(params, context) {
    // 发送通知的逻辑
  }
};
```

### 6.4 PluginContext 类型定义

```typescript
/**
 * 插件运行时上下文
 */
interface PluginContext {
  /** 插件 ID */
  pluginId: string;

  /** 获取插件配置 */
  config: Record<string, any>;

  /** 插件专属存储 */
  storage: {
    get(key: string): Promise<any>;
    set(key: string, value: any): Promise<void>;
    delete(key: string): Promise<void>;
  };

  /** 日志 */
  log(level: 'debug' | 'info' | 'warn' | 'error', message: string): void;

  /** 发布事件 */
  emit(event: string, data?: any): void;

  /** 跨插件调用（需要 permissions 声明）*/
  call(pluginId: string, method: string, params?: any): Promise<any>;

  /** 缓存 API */
  cache: {
    get(key: string): Promise<any | null>;
    set(key: string, value: any, ttlMs?: number): Promise<void>;
    delete(key: string): Promise<void>;
  };

  /** 执行超时时间 (ms) */
  timeout: number;
}
```

### 6.5 错误类型定义

> 与旧插件系统设计文档对齐

```typescript
/**
 * 插件错误类型
 */
enum PluginErrorType {
  NETWORK_ERROR = 'NETWORK_ERROR',      // 网络错误
  AUTH_ERROR = 'AUTH_ERROR',            // 认证错误
  RATE_LIMIT = 'RATE_LIMIT',            // 限流
  TIMEOUT = 'TIMEOUT',                  // 超时
  PARSE_ERROR = 'PARSE_ERROR',          // 解析错误
  PROVIDER_ERROR = 'PROVIDER_ERROR',    // 服务商错误
  SANDBOX_LIMIT = 'SANDBOX_LIMIT',      // 沙盒限制
  PERMISSION_DENIED = 'PERMISSION_DENIED', // 权限拒绝
  UNKNOWN = 'UNKNOWN',                  // 未知错误
}

/**
 * 插件错误类
 */
class PluginError extends Error {
  constructor(
    public type: PluginErrorType,
    public message: string,
    public details?: any
  ) {
    super(message);
  }
}

// 插件中使用
throw new PluginError(
  PluginErrorType.AUTH_ERROR,
  'Session Key 已过期',
  { statusCode: 401 }
);
```

### 6.6 数据类型规范

#### Usage 类型（使用量）

```typescript
interface UsageData {
  dataType: 'usage';

  // 主要指标
  percentage: number;           // 0-100
  used: number;                 // 已用量
  limit: number;                // 限额
  unit: string;                 // 单位，如 "tokens"

  // 重置信息
  resetTime?: string;           // ISO 8601
  resetLabel?: string;          // 如 "5小时会话"

  // 可选：多个使用量维度
  dimensions?: UsageDimension[];

  // 元信息
  lastUpdated: string;          // ISO 8601
}

interface UsageDimension {
  id: string;                   // 如 "session", "weekly", "opus"
  label: string;                // 如 "5小时会话", "周使用量"
  percentage: number;
  used: number;
  limit: number;
  resetTime?: string;
}
```

#### Balance 类型（余额）

```typescript
interface BalanceData {
  dataType: 'balance';

  // 主要指标
  balance: number;              // 余额
  currency: string;             // 货币，如 "USD", "CNY"

  // 可选
  quota?: number;               // 总额度
  usedQuota?: number;           // 已用额度
  expiresAt?: string;           // 到期时间

  // 元信息
  lastUpdated: string;
}
```

#### Status 类型（状态）

```typescript
interface StatusData {
  dataType: 'status';

  // 状态指示
  indicator: 'none' | 'minor' | 'major' | 'critical' | 'unknown';
  description: string;

  // 元信息
  lastUpdated: string;
}
```

### 6.7 沙盒限制

| 限制项 | 值 | 说明 |
|--------|-----|------|
| 内存 | 16MB | 超出则终止 |
| 执行时间 | 30s | 超时则中断 |
| 网络 | 仅 HTTPS | HTTP 请求被拒绝 |
| 本地网络 | 禁止 | localhost/127.0.0.1/私网IP 被拒绝 |
| 文件系统 | 禁止 | 无法访问文件 |
| 全局对象 | 移除危险 API | eval, Function, WebAssembly |

#### 网络限制详细规则

**两层防护策略**：URL 模式拦截 + DNS 解析级别拦截

##### 第一层：URL 模式拦截（请求发起前）

```typescript
// 被拒绝的 URL 模式
const BLOCKED_URL_PATTERNS = [
  /^https?:\/\/localhost/i,
  /^https?:\/\/127\./,
  /^https?:\/\/0\./,
  /^https?:\/\/10\./,
  /^https?:\/\/172\.(1[6-9]|2[0-9]|3[01])\./,
  /^https?:\/\/192\.168\./,
  /^https?:\/\/\[::1\]/,
  /^https?:\/\/\[fe80:/i,
  /^https?:\/\/\[fd[0-9a-f]{2}:/i,  // IPv6 ULA
];

// 仅允许 HTTPS
const isHttps = url.startsWith('https://');
const isBlockedByPattern = BLOCKED_URL_PATTERNS.some(p => p.test(url));

if (!isHttps || isBlockedByPattern) {
  throw new PluginError(PluginErrorType.NETWORK_ERROR, 'URL not allowed');
}
```

##### 第二层：DNS 解析级别拦截（连接建立前）

> 防止域名解析到私网 IP 的 DNS 重绑定攻击

```rust
// Rust 侧实现：在 reqwest 客户端配置 resolve 回调
fn is_private_ip(ip: &IpAddr) -> bool {
    match ip {
        IpAddr::V4(v4) => {
            v4.is_loopback()           // 127.0.0.0/8
            || v4.is_private()         // 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16
            || v4.is_link_local()      // 169.254.0.0/16
            || v4.is_unspecified()     // 0.0.0.0
        }
        IpAddr::V6(v6) => {
            v6.is_loopback()           // ::1
            || v6.is_unspecified()     // ::
            || is_ipv6_ula(v6)         // fd00::/8
            || is_ipv6_link_local(v6)  // fe80::/10
        }
    }
}

// 在连接建立前检查解析后的 IP
let resolved_ip = dns_resolve(hostname)?;
if is_private_ip(&resolved_ip) {
    return Err(PluginError::new(
        PluginErrorType::NETWORK_ERROR,
        "DNS resolved to private IP"
    ));
}
```

| 防护层 | 防护目标 | 实现位置 |
|--------|----------|----------|
| URL 模式拦截 | 显式私网 URL | JS 沙盒 fetch 封装 |
| DNS 级别拦截 | DNS 重绑定攻击 | Rust reqwest 客户端 |

---

## 七、官方插件集 (Official Plugins)

> 由项目维护者维护，托管在 GitHub，可自动更新

### 7.1 claude-usage 插件

| 属性 | 值 |
|------|------|
| **ID** | `claude-usage` |
| **类型** | `DataPlugin` |
| **数据类型** | `usage` |
| **刷新间隔** | 30000ms |

#### 功能

| 功能点 | API | 描述 |
|--------|-----|------|
| 获取组织 ID | `GET /api/organizations` | 首次调用时缓存 |
| 获取使用量 | `GET /api/organizations/{org}/usage` | 主要数据 |

#### 发布的事件

| 事件 | 触发条件 | Payload |
|------|----------|---------|
| `plugin:claude-usage:data_updated` | 每次数据更新 | `UsageData` |
| `plugin:claude-usage:threshold_exceeded` | 使用量超阈值 | `{ percentage, threshold }` |
| `plugin:claude-usage:session_reset` | 会话重置（0%） | `{ resetTime }` |

### 7.2 claude-status 插件

| 属性 | 值 |
|------|------|
| **ID** | `claude-status` |
| **类型** | `DataPlugin` |
| **数据类型** | `status` |
| **刷新间隔** | 60000ms |

### 7.3 claude-balance 插件

| 属性 | 值 |
|------|------|
| **ID** | `claude-balance` |
| **类型** | `DataPlugin` |
| **数据类型** | `balance` |
| **刷新间隔** | 300000ms |

### 7.4 notifications 插件

| 属性 | 值 |
|------|------|
| **ID** | `notifications` |
| **类型** | `EventPlugin` |
| **数据类型** | 无（纯事件处理） |

#### 订阅的事件

```javascript
export const subscribedEvents = [
  'plugin:claude-usage:threshold_exceeded',
  'plugin:claude-usage:session_reset',
  'plugin:claude-status:status_changed',
];
```

#### 暴露的方法

```javascript
export const exposedMethods = {
  async send({ title, body, type = 'info' }, context) {
    // 发送系统通知
  }
};
```

---

## 八、插件分发与更新 (Plugin Distribution)

### 8.1 官方插件仓库

| 属性 | 值 |
|------|------|
| **托管位置** | GitHub: `cuk-team/cuk-plugins` |
| **结构** | 每个插件一个目录 |
| **版本管理** | Git Tag + manifest.json 版本 |

### 8.2 首次安装流程

```
应用首次启动
    │
    ▼
检测 ~/.config/cuk/plugins/ 是否存在
    │
    ├── 存在 → 加载已有插件
    │
    └── 不存在 → 下载官方插件包
                    │
                    ▼
              验证完整性（SHA256）
                    │
                    ▼
              原子解压到临时目录
                    │
                    ▼
              验证插件结构
                    │
                    ▼
              原子移动到 plugins 目录
                    │
                    ▼
              加载并运行
```

### 8.3 安全更新机制

> 解决安装/更新安全攻击面问题

#### 8.3.1 完整性校验与签名验证

**签名对象与验证顺序**（必须严格按此顺序执行）：

```
┌─────────────────────────────────────────────────────────┐
│  签名覆盖范围：manifest.json 文件内容                    │
│  签名算法：Ed25519                                      │
│  公钥分发：嵌入应用二进制                                │
└─────────────────────────────────────────────────────────┘

验证流程：
1. 下载 plugin.zip
2. 解压获取 manifest.json（不执行任何代码）
3. 读取 manifest.json 中的 sha256 和 signature 字段
4. 验证 signature（签名的是 manifest.json 去除 signature 字段后的内容）
5. 验证 sha256（plugin.zip 的哈希，不含 manifest.json）
6. 全部通过后才允许加载插件代码
```

**manifest.json 签名字段规范**：

```json
{
  "id": "claude-usage",
  "version": "1.0.0",
  "files": {
    "plugin.js": "sha256:a1b2c3...",
    "icon.png": "sha256:d4e5f6..."
  },
  "signature": "ed25519:base64编码的签名..."
}
```

| 检查项 | 方法 | 验证顺序 | 说明 |
|--------|------|----------|------|
| 签名验证 | Ed25519 | 1 (最先) | 验证 manifest.json 未被篡改 |
| 文件哈希 | SHA256 | 2 | 逐个验证 files 中声明的哈希 |
| 证书固定 | 公钥嵌入 | - | 公钥编译进应用，防中间人 |

**签名生成（官方发布流程）**：

```bash
# 1. 计算各文件的 SHA256
sha256sum plugin.js icon.png > hashes.txt

# 2. 生成 manifest.json（不含 signature）
cat manifest-unsigned.json

# 3. 对 manifest.json 签名
openssl pkeyutl -sign -inkey private.pem -in manifest-unsigned.json -out sig.bin

# 4. 将签名写入 manifest.json
jq '.signature = "ed25519:'$(base64 sig.bin)'"' manifest-unsigned.json > manifest.json
```

#### 8.3.2 安全解压

| 检查项 | 说明 |
|--------|------|
| 路径穿越防护 | 拒绝包含 `..` 的路径 |
| 符号链接禁止 | 拒绝解压符号链接 |
| 文件大小限制 | 单文件最大 10MB，总大小最大 50MB |
| 文件类型白名单 | 仅允许 .js, .json, .png, .svg |

#### 8.3.3 原子替换

```
1. 解压到临时目录 ~/.config/cuk/plugins/.tmp-{random}/
2. 验证插件结构（metadata, plugin.js 存在）
3. 备份旧版本到 ~/.config/cuk/plugins/.backup/{id}-{version}/
4. 原子重命名：mv .tmp-{random}/{id} plugins/{id}
5. 成功后删除备份（或保留 N 个版本）
```

#### 8.3.4 回滚机制

| 场景 | 动作 |
|------|------|
| 新版本加载失败 | 自动回滚到备份版本 |
| 新版本运行崩溃 | 标记为不健康，提示用户回滚 |
| 用户手动回滚 | 设置界面提供回滚入口 |

### 8.4 自动更新流程

```
定时检查（每 24 小时）
    │
    ▼
获取远程 manifest.json
    │
    ▼
对比本地版本
    │
    ├── 无更新 → 结束
    │
    └── 有更新 → 下载插件包
                    │
                    ▼
              验证 SHA256 + 签名
                    │
                    ▼
              安全解压（路径穿越检查）
                    │
                    ▼
              原子替换
                    │
                    ▼
              热重载（调用 onUnload → onLoad）
```

### 8.5 手动安装

```bash
# 从 URL 安装（需要签名验证）
cuk plugin install https://example.com/my-plugin.zip

# 从本地安装（警告：未签名插件）
cuk plugin install ./my-plugin/

# 安装时跳过签名验证（需用户确认）
cuk plugin install --skip-signature ./my-plugin/
```

---

## 九、安全机制 (Security)

### 9.1 插件隔离

| 维度 | 措施 |
|------|------|
| 运行时 | 每个插件独立 QuickJS 实例 |
| 内存 | 16MB 限制，超出终止 |
| CPU | 中断处理器，防死循环 |
| 网络 | 仅 HTTPS，禁止本地网络（localhost/私网IP） |
| 文件 | 完全禁止 |
| 跨插件 | 需要 permissions 声明 |

### 9.2 官方插件签名

| 功能 | 描述 |
|------|------|
| 签名算法 | Ed25519 |
| 公钥分发 | 嵌入应用二进制 |
| 签名验证 | 自动更新时必须验证 |
| 手动安装 | 警告未签名插件，需用户确认 |

### 9.3 配置安全

| 措施 | 描述 |
|------|------|
| Secret 字段 | 配置 UI 中隐藏显示 |
| 加密存储 | 敏感配置使用系统 Keychain 存储 |
| 权限隔离 | 插件只能访问自己的配置 |

---

## 十、IPC 接口契约

### 10.1 类型定义

```typescript
// ========== 基础类型 ==========

/** 操作结果 */
interface Result<T = void> {
  success: boolean;
  data?: T;
  error?: AppError;
}

/** 应用错误 */
interface AppError {
  code: string;           // 错误码
  message: string;        // 用户可读消息
  details?: unknown;      // 详细信息
}

// ========== 插件相关类型 ==========

/** 插件信息 */
interface PluginInfo {
  id: string;
  name: string;
  version: string;
  pluginType: 'data' | 'event' | 'hybrid';
  dataType?: 'usage' | 'balance' | 'status' | 'custom';
  enabled: boolean;
  healthy: boolean;
  author?: string;
  description?: string;
  icon?: string;
}

/** 更新信息 */
interface UpdateInfo {
  id: string;
  currentVersion: string;
  latestVersion: string;
  releaseNotes?: string;
  downloadUrl: string;
  sha256: string;
  signature: string;
}

/** 配置验证结果 */
interface ValidationResult {
  valid: boolean;
  message?: string;
  fieldErrors?: Record<string, string>;
}

/** 插件健康状态 */
interface PluginHealth {
  pluginId: string;
  status: 'healthy' | 'degraded' | 'unhealthy';
  lastSuccess?: string;    // ISO 8601
  lastError?: string;
  errorCount: number;
  avgLatencyMs: number;
  successRate: number;
}

// ========== 插件数据类型（联合类型）==========

/** 插件数据基础接口 */
interface PluginDataBase {
  pluginId: string;        // 数据来源插件
  lastUpdated: string;     // ISO 8601
}

/** Usage 类型数据 */
interface UsageData extends PluginDataBase {
  dataType: 'usage';
  percentage: number;           // 0-100
  used: number;
  limit: number;
  unit: string;
  resetTime?: string;
  resetLabel?: string;
  dimensions?: UsageDimension[];
}

interface UsageDimension {
  id: string;
  label: string;
  percentage: number;
  used: number;
  limit: number;
  resetTime?: string;
}

/** Balance 类型数据 */
interface BalanceData extends PluginDataBase {
  dataType: 'balance';
  balance: number;
  currency: string;
  quota?: number;
  usedQuota?: number;
  expiresAt?: string;
}

/** Status 类型数据 */
interface StatusData extends PluginDataBase {
  dataType: 'status';
  indicator: 'none' | 'minor' | 'major' | 'critical' | 'unknown';
  description: string;
}

/** Custom 类型数据 */
interface CustomData extends PluginDataBase {
  dataType: 'custom';
  /** 自定义渲染模板（HTML 片段，会被 sanitize） */
  renderHtml?: string;
  /** 自定义数据（插件自定义结构） */
  payload: Record<string, unknown>;
  /** 可选：卡片标题 */
  title?: string;
  /** 可选：卡片副标题 */
  subtitle?: string;
}

/** 插件数据联合类型 */
type PluginData = UsageData | BalanceData | StatusData | CustomData;
```

### 10.2 插件管理 Commands

| Command | 参数 | 返回值 |
|---------|------|--------|
| `plugin_list` | - | `Result<PluginInfo[]>` |
| `plugin_enable` | `{ id: string }` | `Result` |
| `plugin_disable` | `{ id: string }` | `Result` |
| `plugin_install` | `{ source: string, skipSignature?: boolean }` | `Result<PluginInfo>` |
| `plugin_uninstall` | `{ id: string }` | `Result` |
| `plugin_reload` | `{ id: string }` | `Result` |
| `plugin_check_updates` | - | `Result<UpdateInfo[]>` |
| `plugin_update` | `{ id: string }` | `Result<PluginInfo>` |
| `plugin_rollback` | `{ id: string, version: string }` | `Result` |

### 10.3 数据 Commands

| Command | 参数 | 返回值 |
|---------|------|--------|
| `get_all_data` | - | `Result<PluginData[]>` |
| `get_plugin_data` | `{ id: string }` | `Result<PluginData>` |
| `refresh_plugin` | `{ id: string, force?: boolean }` | `Result<PluginData>` |
| `refresh_all` | `{ force?: boolean }` | `Result<PluginData[]>` |

### 10.4 配置 Commands

| Command | 参数 | 返回值 |
|---------|------|--------|
| `get_plugin_config` | `{ id: string }` | `Result<Record<string, any>>` |
| `set_plugin_config` | `{ id: string, config: Record<string, any> }` | `Result` |
| `validate_plugin_config` | `{ id: string, config: Record<string, any> }` | `Result<ValidationResult>` |

### 10.5 监控 Commands

| Command | 参数 | 返回值 |
|---------|------|--------|
| `get_all_health` | - | `Result<PluginHealth[]>` |
| `get_plugin_health` | `{ id: string }` | `Result<PluginHealth>` |

### 10.6 Events

| Event | Payload | 描述 |
|-------|---------|------|
| `ipc:plugin_installed` | `PluginInfo` | 插件安装完成 |
| `ipc:plugin_uninstalled` | `{ id: string }` | 插件卸载完成 |
| `ipc:plugin_updated` | `PluginInfo` | 插件更新完成 |
| `ipc:plugin_data_updated` | `{ id: string, data: PluginData }` | 插件数据更新 |
| `ipc:plugin_error` | `{ id: string, error: AppError }` | 插件错误 |
| `ipc:plugin_health_changed` | `PluginHealth` | 健康状态变化 |

---

## 十一、目录结构

### 11.1 应用核心 (src-tauri/)

```
src-tauri/src/
├── main.rs                     # 入口
├── plugin/                     # 插件系统核心
│   ├── mod.rs
│   ├── runtime.rs              # QuickJS 运行时
│   ├── lifecycle.rs            # 生命周期管理
│   ├── bus.rs                  # 通信总线
│   ├── config.rs               # 配置管理
│   ├── reliability/            # 可靠性层
│   │   ├── scheduler.rs        # 并发调度器
│   │   ├── rate_limiter.rs     # 限流器
│   │   ├── cache.rs            # 缓存层
│   │   └── retry.rs            # 重试机制
│   ├── sandbox/                # 沙盒相关
│   │   ├── fetch.rs            # fetch API（含网络限制）
│   │   ├── console.rs          # console API
│   │   └── ...
│   ├── security/               # 安全相关
│   │   ├── signature.rs        # 签名验证
│   │   ├── integrity.rs        # 完整性校验
│   │   └── safe_extract.rs     # 安全解压
│   └── types.rs                # 类型定义
├── monitoring/                 # 监控层
├── commands/                   # IPC Commands
└── state.rs
```

### 11.2 插件目录

```
~/.config/cuk/
├── plugins/                    # 插件目录
│   ├── claude-usage/
│   │   ├── plugin.js
│   │   └── icon.png
│   ├── claude-status/
│   ├── claude-balance/
│   ├── notifications/
│   ├── openai-balance/
│   ├── .backup/                # 备份目录
│   │   └── claude-usage-1.0.0/
│   └── .tmp-xxxxx/             # 临时目录（安装中）
├── configs/                    # 插件配置
│   ├── claude-usage.json
│   ├── openai-balance.json
│   └── ...
└── cache/                      # 数据缓存
```

---

## 十二、兼容性与迁移

### 12.1 与旧插件系统的差异

| 维度 | 旧文档 (插件系统设计文档.md) | 新规范 |
|------|------------------------------|--------|
| 插件路径 | `~/.claude/plugins/balance/` | `~/.config/cuk/plugins/` |
| 核心函数 | `queryBalance()` | `fetchData()` |
| 数据结构 | `BalanceResult` | `PluginData (usage/balance/status)` |
| 错误类型 | 已定义 | 保持兼容 |
| 沙盒实现 | rquickjs 0.6 | 保持兼容 |

### 12.2 迁移策略

```javascript
// 兼容层：将旧 queryBalance 适配为新 fetchData
export async function fetchData(config, context) {
  // 调用旧 API
  const result = await queryBalance(config, context);

  // 转换为新格式
  return {
    dataType: 'balance',
    balance: result.balance,
    currency: result.currency,
    quota: result.quota,
    usedQuota: result.used_quota,
    expiresAt: result.expires_at,
    lastUpdated: result.last_updated,
  };
}
```

### 12.3 向后兼容

| 特性 | 兼容性 |
|------|--------|
| 旧 `queryBalance` 函数 | 运行时自动适配 |
| 旧 `BalanceResult` 结构 | 自动转换为 `PluginData` |
| 旧错误类型 | 完全兼容 |
| 旧配置格式 | 自动迁移 |

---

## 十三、功能统计

| 类别 | 数量 |
|------|------|
| 应用核心模块 | 8 (Runtime/Lifecycle/Bus/Config/Scheduler/RateLimiter/Cache/Retry) |
| 官方插件 | 4 (usage/status/balance/notifications) |
| 插件类型 | 3 (DataPlugin/EventPlugin/HybridPlugin) |
| 注入 API | 11 |
| 数据类型 | 4 (usage/balance/status/custom) |
| IPC Commands | 18 |
| IPC Events | 6 |

---

## 十四、与旧架构对比

| 维度 | 旧架构 | 新架构 |
|------|--------|--------|
| Claude 功能 | 内置硬编码 | 外置插件 (claude-*.js) |
| API 变化响应 | 发布新应用 | 更新插件 |
| 更新速度 | 天/周级 | 分钟级 |
| 用户定制 | 无 | 可修改/创建插件 |
| 社区贡献 | 提 PR | 发布插件 |
| 安全更新 | 无 | 签名验证 + 原子替换 |

---

**文档版本**: v2.2 (All-External Plugin Architecture)
**设计时间**: 2025-12-27
**审核工具**: Codex (gpt-5.2 + xhigh reasoning)
**核心理念**: 应用核心 = 纯运行时，所有功能 = 可热更新的外置插件

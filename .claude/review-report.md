# Phase 2: æ’ä»¶è¿è¡Œæ—¶æ ¸å¿ƒ - Codex å®¡æ ¸æŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-28
**å®¡æ ¸æ–¹å¼**: Codex (model_reasoning_effort: xhigh)
**å®¡æ ¸è€—æ—¶**: 825 ç§’
**ç»¼åˆè¯„åˆ†**: 58/100
**å®¡æ ¸ç»“è®º**: âŒ **ä¸é€šè¿‡**ï¼ˆæœªè¾¾åˆ° >90 é€šè¿‡é—¨æ§›ï¼‰

---

## é«˜é£é™©é—®é¢˜åˆ—è¡¨

### 1. ğŸ”´ è¶…æ—¶æœºåˆ¶é»˜è®¤ä¸ç”Ÿæ•ˆ (runtime.rs:125)

**é—®é¢˜**: `start_time_ms` åˆå§‹ä¸º 0ï¼Œ`should_interrupt()` åœ¨ `start()` ä¹‹å‰ç›´æ¥è¿”å› falseã€‚å½“å‰åªæœ‰ `Executor` è°ƒç”¨äº† `start_execution()`ï¼Œä½† `Executor` é‡Œå¹¶æœªçœŸæ­£æ‰§è¡Œ `context.with`/`ctx.eval`ï¼ˆä»…ç¤ºä¾‹ `Ok(f())`ï¼‰ï¼Œå¯¼è‡´ä¸Šå±‚è‹¥ç›´æ¥ eval å¯èƒ½å®Œå…¨æ²¡æœ‰ CPU è¶…æ—¶ä¿æŠ¤ï¼ˆæ— é™å¾ªç¯/DoSï¼‰ã€‚

**å½±å“**: é«˜ - æ²™ç›’å®‰å…¨æ ¸å¿ƒæœºåˆ¶å¤±æ•ˆ

---

### 2. ğŸ”´ å­˜åœ¨ä¼šç›´æ¥ abort è¿›ç¨‹çš„ panic è·¯å¾„ (runtime.rs:97)

**é—®é¢˜**: `SystemTime::duration_since(...).unwrap()` ä¸ `Cargo.toml` ä¸­ `panic = "abort"` ç»„åˆï¼Œé‡åˆ°ç³»ç»Ÿæ—¶é’Ÿå¼‚å¸¸ç­‰æƒ…å†µä¼šç›´æ¥ç»ˆæ­¢è¿›ç¨‹ã€‚

**å½±å“**: é«˜ - ç¨³å®šæ€§é£é™©

---

### 3. ğŸ”´ console æ•°ç»„é€’å½’æ— å¾ªç¯æ£€æµ‹ (console.rs:123)

**é—®é¢˜**: `console.*` å¯¹æ•°ç»„é€’å½’å±•å¼€æ— å¾ªç¯æ£€æµ‹ã€‚è‡ªå¼•ç”¨æ•°ç»„ï¼ˆå¦‚ `a.push(a)`ï¼‰ä¼šå¯¼è‡´æ— é™é€’å½’ç›´è‡³æ ˆæº¢å‡ºï¼Œå±äºå¯è¢«æ’ä»¶è½»æ˜“è§¦å‘çš„å´©æºƒå‹ DoSã€‚

**å½±å“**: é«˜ - DoS æ”»å‡»å‘é‡

---

### 4. ğŸ”´ Rust ä¾§åˆ†é…ç»•è¿‡ QuickJS å†…å­˜é™åˆ¶ (runtime.rs:206, encoding.rs:112)

**é—®é¢˜**: `set_memory_limit` åªé™åˆ¶ QuickJS å †ã€‚`atob/btoa`ã€`TextEncoder/Decoder` ç­‰ä¼šæŠŠ JS å­—ç¬¦ä¸²/å­—èŠ‚å¤åˆ¶åˆ° Rust `String/Vec` å¹¶äº§ç”Ÿé¢å¤–åˆ†é…ï¼Œä¸”æ— ä»»ä½•é•¿åº¦/é…é¢é™åˆ¶ï¼Œå­˜åœ¨ OOM é£é™©ã€‚

**å½±å“**: é«˜ - å†…å­˜å®‰å…¨

---

### 5. ğŸ”´ URL å®‰å…¨æ£€æŸ¥è¦†ç›–ä¸è¶³ (fetch.rs:208)

**é—®é¢˜**:
- IPv6 ç§ç½‘/é“¾è·¯æœ¬åœ°/IPv4-mapped IPv6 ç­‰æœªè¢« `is_private_ip` æ‹¦æˆªï¼ˆä»… `loopback/unspecified`ï¼‰
- `check_resolved_ip()` æ²¡æœ‰åœ¨ `fetch` ä¸­è°ƒç”¨
- æœªå¤„ç†é‡å®šå‘æ ¡éªŒé“¾è·¯

**å½±å“**: é«˜ - SSRF/å†…ç½‘æ¢æµ‹é£é™©

---

### 6. ğŸŸ¡ RequestManager::new() ä½¿ç”¨ .expect() (fetch.rs:139)

**é—®é¢˜**: ä¸€æ—¦æ„å»º client å¤±è´¥ä¼šç›´æ¥ abortï¼Œç¨³å®šæ€§é£é™©é«˜ï¼ˆå°¤å…¶åœ¨ release é…ç½®ï¼‰ã€‚

**å½±å“**: ä¸­ - ç¨³å®šæ€§

---

## æ”¹è¿›å»ºè®®

### å¿…é¡»ä¿®å¤ (é˜»å¡å‘å¸ƒ)

| ä¼˜å…ˆçº§ | æ–‡ä»¶ | é—®é¢˜ | å»ºè®®ä¿®å¤æ–¹æ¡ˆ |
|--------|------|------|-------------|
| P0 | runtime.rs:355 | è¶…æ—¶/ä¸­æ–­å¯åœæœªå¼ºåˆ¶å°è£… | æä¾›å”¯ä¸€æ‰§è¡Œå…¥å£ `run_with_limits`ï¼Œåœ¨æ¯æ¬¡ `ctx.eval` å‰åè‡ªåŠ¨ `start/reset` |
| P0 | runtime.rs:137 | æ—¶é—´å·®è®¡ç®—å¯èƒ½ panic | ç”¨ `saturating_sub` æˆ–å•è°ƒæ—¶é’Ÿæ–¹æ¡ˆï¼Œå‡å°‘ `unwrap()` |
| P0 | console.rs:123 | å¾ªç¯å¼•ç”¨å´©æºƒ | å¢åŠ æ·±åº¦é™åˆ¶ + è®¿é—®é›†æ£€æµ‹ï¼Œå•æ¬¡æ—¥å¿—è¾“å‡ºå¤§å°æˆªæ–­ |
| P0 | encoding.rs:112 | Rust å †åˆ†é…ç»•è¿‡é™åˆ¶ | ä¸º `atob/btoa/TextEncoder/TextDecoder` å¢åŠ è¾“å…¥å¤§å°é™åˆ¶ä¸é…é¢ç»Ÿè®¡ |
| P0 | fetch.rs:208 | URL å®‰å…¨æ£€æŸ¥ä¸å®Œæ•´ | å®Œå–„ IPv6 ç§ç½‘åˆ¤æ–­ï¼Œè°ƒç”¨ `check_resolved_ip()`ï¼Œå¤„ç†é‡å®šå‘ |

### å»ºè®®ä¿®å¤ (è´¨é‡æå‡)

| ä¼˜å…ˆçº§ | æ–‡ä»¶ | é—®é¢˜ | å»ºè®® |
|--------|------|------|------|
| P1 | fetch.rs:139 | .expect() å¯èƒ½ abort | æ”¹ç”¨ Result è¿”å› |
| P1 | å¤šå¤„ | dead_code warnings | æ¸…ç†æœªä½¿ç”¨ä»£ç æˆ–æ·»åŠ  #[allow(dead_code)] |
| P2 | timer.rs | æœªå®Œå…¨å®ç° | å®Œæˆ setTimeout/clearTimeout å®é™…é€»è¾‘ |

---

## è¯„åˆ†æ˜ç»†

| ç»´åº¦ | å¾—åˆ† | æ»¡åˆ† | è¯´æ˜ |
|------|------|------|------|
| å®‰å…¨æ€§ | 35 | 50 | è¶…æ—¶æœºåˆ¶ã€å†…å­˜é™åˆ¶ã€URLæ£€æŸ¥å­˜åœ¨ç¼ºé™· |
| ä»£ç è´¨é‡ | 12 | 20 | panic è·¯å¾„ã€å¾ªç¯å¼•ç”¨é—®é¢˜ |
| API è®¾è®¡ | 8 | 15 | rquickjs class å®ä½¿ç”¨æ­£ç¡®ï¼Œä½†æ‰§è¡Œå…¥å£è®¾è®¡ä¸å®Œå–„ |
| æ¶æ„ | 3 | 15 | æ¨¡å—åˆ’åˆ†æ¸…æ™°ï¼Œä½†å…³é”®å®‰å…¨æœºåˆ¶æœªé—­ç¯ |
| **æ€»åˆ†** | **58** | **100** | |

---

## ç»“è®º

**Phase 2 æœªé€šè¿‡å®¡æ ¸**ï¼Œå­˜åœ¨å¤šä¸ªé«˜é£é™©å®‰å…¨é—®é¢˜éœ€è¦ä¿®å¤ï¼š

1. æ²™ç›’è¶…æ—¶æœºåˆ¶æœªæ­£ç¡®ç”Ÿæ•ˆ
2. å†…å­˜é™åˆ¶å¯è¢« Rust ä¾§åˆ†é…ç»•è¿‡
3. console å­˜åœ¨ DoS æ”»å‡»å‘é‡
4. URL å®‰å…¨æ£€æŸ¥ä¸å®Œæ•´

å»ºè®®ï¼šåœ¨ä¿®å¤ä¸Šè¿° P0 é—®é¢˜åé‡æ–°æäº¤å®¡æ ¸ã€‚

---

**å®¡æ ¸äºº**: Codex (GPT-5.2, reasoning_effort: xhigh)
**å®¡æ ¸æ—¶é—´**: 2025-12-28

---

# Phase 7: IPC/Tray/Window æ·±åº¦ä»£ç å®¡æ ¸æŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-28 06:12ï¼ˆUTC+8ï¼‰

**å®¡æ ¸èŒƒå›´**:
- `src-tauri/src/commands/ipc.rs`ï¼ˆPhase 7 ä¿®å¤ï¼šIPC å†™é”ä½œç”¨åŸŸï¼‰
- `src-tauri/src/commands/plugin.rs`ï¼ˆRwLock ä½¿ç”¨ï¼‰
- `src-tauri/src/tray/mod.rs`ï¼ˆæ‰˜ç›˜ç®¡ç†ï¼‰
- `src-tauri/src/window/mod.rs`ï¼ˆçª—å£ç®¡ç†ï¼‰

**ç»¼åˆè¯„åˆ†**: 65/100  
**å®¡æ ¸ç»“è®º**: **éœ€è®¨è®º**ï¼ˆé”ä½œç”¨åŸŸä¿®å¤é€šè¿‡ï¼Œä½†åŒå±‚é”/é”™è¯¯å¤„ç†ä¸ IPC å‘½ä»¤æœªå®ç°å¯¼è‡´æ•´ä½“æœªè¾¾å¯å‘å¸ƒè´¨é‡ï¼‰

---

## å®¡æ ¸é‡ç‚¹é€é¡¹éªŒè¯

### 1) å†™é”ä½œç”¨åŸŸæ˜¯å¦æ­£ç¡®ç¼©å°ï¼ˆemit åœ¨é”é‡Šæ”¾åæ‰§è¡Œï¼‰

**ç»“è®º**: é€šè¿‡ï¼ˆå½“å‰ä»…åœ¨é”™è¯¯åˆ†æ”¯ emitï¼‰

**è¯æ®**:
- `plugin_enable` ä½¿ç”¨å—è¡¨è¾¾å¼åŒ…è£¹ `state.0.write().await`ï¼Œåœ¨å—ç»“æŸå¤„é‡Šæ”¾å†™é”åï¼Œå†è°ƒç”¨ `emitter(&app).emit_plugin_error(...)`ï¼ˆ`src-tauri/src/commands/ipc.rs:34-47`ï¼‰ã€‚
- `plugin_disable` åŒæ ·åœ¨å—ç»“æŸé‡Šæ”¾å†™é”å emit é”™è¯¯äº‹ä»¶ï¼ˆ`src-tauri/src/commands/ipc.rs:58-71`ï¼‰ã€‚

**è§‚å¯Ÿ**:
- å†™é”ä»ä¼šè·¨ `await` æŒæœ‰ï¼ˆ`manager.enable_plugin(&id).await`ï¼‰ï¼Œä½†å½“å‰ `PluginManager::enable_plugin` ä»…åš HashMap å†…éƒ¨å†™é” + å­—æ®µä¿®æ”¹ï¼Œé£é™©è¾ƒä½ï¼›åç»­è‹¥å¼•å…¥è€—æ—¶ I/Oï¼ˆå¦‚åŠ è½½/å¸è½½åŠ¨æ€åº“ï¼‰éœ€é‡æ–°è¯„ä¼°æŒé”æ—¶é•¿ã€‚

### 2) RwLock è¯»å†™é”ä½¿ç”¨æ˜¯å¦æ­£ç¡®

**ç»“è®º**: åŸºæœ¬æ­£ç¡®ï¼Œä½†å­˜åœ¨æ˜æ˜¾å†—ä½™/é”ç²’åº¦è¿‡å¤§é—®é¢˜

**è¯æ®**:
- Phase 2 å‘½ä»¤ï¼šè¯»æ“ä½œ `read()`ï¼ˆlist/get/dirï¼‰ï¼Œå†™æ“ä½œ `write()`ï¼ˆenable/disable/discoverï¼‰ï¼ˆ`src-tauri/src/commands/plugin.rs:16,37,51,64`ï¼‰ã€‚
- Phase 7 IPC å‘½ä»¤ï¼šlist ä½¿ç”¨ `read()`ï¼Œenable/disable ä½¿ç”¨ `write()`ï¼ˆ`src-tauri/src/commands/ipc.rs:22,36,60`ï¼‰ã€‚
- ä¸¤å¥—å‘½ä»¤å‡è¢«åŒæ—¶æ³¨å†Œåˆ° `invoke_handler`ï¼ˆ`src-tauri/src/lib.rs:19-55`ï¼‰ï¼Œå› æ­¤é”è®¾è®¡ä¸å¹¶å‘è¯­ä¹‰ä¼šåŒæ—¶å½±å“æ—§/æ–°å‘½ä»¤è°ƒç”¨è·¯å¾„ã€‚

**é—®é¢˜**:
- `PluginManagerState` å¤–å±‚ `Arc<RwLock<PluginManager>>` ä¸ `PluginManager` å†…éƒ¨ `plugins: RwLock<HashMap<...>>` å½¢æˆâ€œåŒå±‚é”â€ï¼ˆ`src-tauri/src/commands/plugin.rs:11`ï¼›`src-tauri/src/plugin/lifecycle.rs:392`ï¼‰ã€‚
- å¤–å±‚åœ¨ enable/disable/discover æ—¶ä½¿ç”¨å†™é”ä¼šé˜»å¡å¹¶å‘è¯»ï¼ˆå¦‚ listï¼‰ï¼Œä½† `PluginManager::enable_plugin/disable_plugin/discover_and_load` å‡æ˜¯ `&self` æ–¹æ³•å¹¶ä¸”å†…éƒ¨å·²ä½¿ç”¨ `self.plugins.write().await` ä¿æŠ¤ä¿®æ”¹ï¼ˆ`src-tauri/src/plugin/lifecycle.rs:410-473`ï¼‰ï¼Œå› æ­¤å¤–å±‚å†™é”åœ¨è¯­ä¹‰ä¸Šå¹¶éå¿…é¡»ï¼Œå±äºé¢å¤–å¹¶å‘çº¦æŸã€‚

### 3) é”™è¯¯å¤„ç†æ˜¯å¦å®Œæ•´

**ç»“è®º**: éƒ¨åˆ†å®Œæ•´ï¼Œå­˜åœ¨å¤§é‡â€œé™é»˜å¿½ç•¥é”™è¯¯â€çš„åœºæ™¯

**è¯æ®ä¸é—®é¢˜**:
- IPC å‘½ä»¤åœ¨ emit å¤±è´¥æ—¶å¿½ç•¥è¿”å›å€¼ï¼š`let _ = emitter(...).emit_plugin_error(...)`ï¼ˆ`src-tauri/src/commands/ipc.rs:45,69`ï¼‰ï¼Œå¯¼è‡´äº‹ä»¶ä¸¢å¤±æ—¶ç¼ºä¹å®šä½çº¿ç´¢ã€‚
- æ‰˜ç›˜èœå•ä¸çª—å£æ“ä½œä¸­å¤§é‡ `let _ = window.show()` / `let _ = app.emit(...)`ï¼ˆ`src-tauri/src/tray/mod.rs:146-154,194-196,207-214,248-250`ï¼‰ï¼Œç¼ºå°‘æ—¥å¿—æˆ–æ˜¾å¼å¤„ç†ã€‚
- çª—å£å¹¿æ’­å‡½æ•°ä½¿ç”¨ `?` ä¼ æ’­ `tauri::Error`ï¼Œè¿™éƒ¨åˆ†å¤„ç†ç›¸å¯¹å®Œæ•´ï¼ˆ`src-tauri/src/window/mod.rs:215-249`ï¼‰ã€‚
- åœ¨æœ¬æ¬¡å®¡æŸ¥èŒƒå›´ï¼ˆ4 ä¸ªæ–‡ä»¶ï¼‰å†…æœªå‘ç° `unwrap()`/`expect()` ç­‰ä¼šç›´æ¥ panic çš„è°ƒç”¨ç‚¹ï¼Œæ•´ä½“ç¨³å®šæ€§åŸºçº¿è¾ƒå¥½ã€‚

**å»ºè®®**:
- å¯¹ç”¨æˆ·è·¯å¾„ä¸Šçš„å¤±è´¥è‡³å°‘ `log::warn!/error!`ï¼›å¯¹å…³é”®è·¯å¾„ï¼ˆemit/broadcastï¼‰å»ºè®®ç»Ÿä¸€å°è£…è¾…åŠ©å‡½æ•°ï¼ˆå¸¦æ—¥å¿—ä¸ä¸Šä¸‹æ–‡ï¼‰æˆ–é€‰æ‹©æ€§ä¸ŠæŠ›ï¼Œé¿å…â€œå¤±è´¥ä½†æ— ç—•â€ã€‚

### 4) IPC Events emit è°ƒç”¨æ˜¯å¦æ­£ç¡®

**ç»“è®º**: åŸºæœ¬æ­£ç¡®

**è¯æ®**:
- `IpcEventEmitter` ç»Ÿä¸€ä½¿ç”¨ `AppHandle.emit`ï¼Œpayload ç±»å‹å‡ `Serialize`ï¼Œäº‹ä»¶åé›†ä¸­ç®¡ç†ï¼ˆ`src-tauri/src/commands/events.rs:12-115`ï¼‰ã€‚
- Window çŠ¶æ€åŒæ­¥äº‹ä»¶å®šä¹‰å¸¸é‡å¹¶åœ¨å¹¿æ’­å‡½æ•°ä¸­ `app.emit(...)?`ï¼ˆ`src-tauri/src/window/mod.rs:195-249`ï¼‰ã€‚

**æ³¨æ„**:
- æ‰˜ç›˜åˆ·æ–°äº‹ä»¶ `"tray:refresh"` ä¸ºç‹¬ç«‹å‘½åä½“ç³»ï¼Œæœªçº³å…¥ `event_names`ï¼Œéœ€ç¡®ä¿å‰ç«¯ç›‘å¬ä¸€è‡´ï¼ˆ`src-tauri/src/tray/mod.rs:153`ï¼‰ã€‚

### 5) ä»£ç é£æ ¼å’Œæ³¨é‡Šè§„èŒƒ

**ç»“è®º**: é£æ ¼æ•´ä½“ä¸€è‡´ï¼Œä½†å­˜åœ¨å°‘é‡ä¸€è‡´æ€§ä¸å¯è¯»æ€§é—®é¢˜

**è§‚å¯Ÿ**:
- æ–‡ä»¶å¤´ä¸æ¨¡å—åˆ†æ®µæ¸…æ™°ï¼Œæ³¨é‡Šä»¥ä¸­æ–‡ä¸ºä¸»ï¼ˆ4 ä¸ªæ–‡ä»¶å‡ç¬¦åˆå½“å‰é¡¹ç›®é£æ ¼ï¼‰ã€‚
- Phase 7 IPC æ–‡ä»¶å£°æ˜â€œ18 ä¸ªå‘½ä»¤â€ï¼Œä½†å¤šæ•°ä»ä¸º TODO/NOT_IMPLEMENTEDï¼ˆ`src-tauri/src/commands/ipc.rs` å¤šå¤„ï¼‰ï¼Œä¼šå½±å“ä»£ç ä¸å¥‘çº¦ä¸€è‡´æ€§çš„è®¤çŸ¥ä¸éªŒæ”¶è¾¹ç•Œã€‚

---

## ä¸»è¦é—®é¢˜ä¸æ”¹è¿›å»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### P0ï¼ˆå»ºè®®å°½å¿«è®¨è®ºå¹¶å®šç¨¿ï¼‰

1) **PluginManagerState åŒå±‚é”è®¾è®¡**
- å¤–å±‚ `RwLock<PluginManager>` ä¸å†…å±‚ `PluginManager.plugins: RwLock<HashMap<...>>` å åŠ ï¼Œä¸”å¤–å±‚å†™é”å¤šæ•°å¹¶éå¿…é¡»ï¼Œä¼šé™ä½å¹¶å‘å¹¶æé«˜æœªæ¥æ­»é”é£é™©ï¼ˆé”é¡ºåºå˜å¤æ‚ï¼‰ã€‚
- å»ºè®®é€‰ä¸€ï¼š
  - æ–¹æ¡ˆ Aï¼šç§»é™¤å¤–å±‚é”ï¼Œæ”¹ä¸º `PluginManagerState(pub Arc<PluginManager>)`ï¼Œç”± `PluginManager` å†…éƒ¨é”è´Ÿè´£å¹¶å‘ã€‚
  - æ–¹æ¡ˆ Bï¼šä¿ç•™å¤–å±‚é”ï¼Œç§»é™¤ `PluginManager.plugins` å†…éƒ¨é”ï¼ˆè®©å¤–å±‚æˆä¸ºå”¯ä¸€åŒæ­¥ç‚¹ï¼‰ï¼Œå¹¶è°ƒæ•´æ–¹æ³•ç­¾å/å¯å˜å€Ÿç”¨ç­–ç•¥ã€‚

### P1ï¼ˆè´¨é‡æå‡ï¼Œé™ä½çº¿ä¸Šæ’éšœæˆæœ¬ï¼‰

2) **emit/show/hide ç­‰é”™è¯¯é™é»˜å¿½ç•¥**
- å»ºè®®å¯¹å…³é”®å¤±è´¥è¡¥å……æ—¥å¿—ï¼ˆè‡³å°‘ `warn`ï¼‰ï¼Œå¹¶åœ¨é”™è¯¯æ—¥å¿—ä¸­åŒ…å« window label / event name / payload å…³é”®ä¿¡æ¯ï¼ˆé¿å…æ³„éœ²æ•æ„Ÿæ•°æ®çš„å‰æä¸‹ï¼‰ã€‚

### P2ï¼ˆå®Œæ•´æ€§ä¸ä¸€è‡´æ€§ï¼‰

3) **IPC Commands å¤§é‡æœªå®ç°**
- `plugin_install/uninstall/reload/update...` ä¸ `data/config/health` å¤šä¸ºå ä½è¿”å›ï¼Œå½±å“ Phase 7 çš„â€œå¥‘çº¦å¯¹é½â€ä¸éªŒæ”¶ã€‚
- å»ºè®®ï¼šæ˜ç¡®å“ªäº›å‘½ä»¤å±äº Phase 7 å¿…é¡»äº¤ä»˜ï¼Œå“ªäº›å»¶åï¼Œå¹¶åœ¨å‰ç«¯è°ƒç”¨ä¾§åšæ˜¾å¼éš”ç¦»ï¼ˆé¿å…è¿è¡ŒæœŸèµ°åˆ° NOT_IMPLEMENTEDï¼‰ã€‚

---

## è¯„åˆ†æ˜ç»†ï¼ˆ0-100ï¼‰

| ç»´åº¦ | å¾—åˆ† | æ»¡åˆ† | è¯´æ˜ |
|------|------|------|------|
| æŠ€æœ¯æ­£ç¡®æ€§ | 24 | 30 | å†™é”ä½œç”¨åŸŸä¿®å¤åˆ°ä½ï¼›emit/broadcast API ä½¿ç”¨æ­£ç¡®ï¼›ä½†å­˜åœ¨é”ç²’åº¦å†—ä½™ä¸é”™è¯¯é™é»˜ |
| æ¶æ„è®¾è®¡ | 15 | 25 | æ¨¡å—è¾¹ç•Œæ¸…æ™°ï¼›ä½† PluginManagerState åŒå±‚é”ä¸åŒå‘½ä»¤ä½“ç³»å¢åŠ å¤æ‚åº¦ |
| å®‰å…¨æ€§ | 16 | 20 | å½“å‰èŒƒå›´å†…æ— æ˜æ˜¾é«˜å±ç‚¹ï¼›ä½†é™é»˜å¤±è´¥ä¼šå‰Šå¼±å¯è§‚æµ‹æ€§ä¸å¼‚å¸¸å¤„ç½®èƒ½åŠ› |
| å®Œæ•´æ€§ | 10 | 25 | Phase 7 IPC å¤šæ•°å‘½ä»¤ä»ä¸ºå ä½å®ç° |
| **æ€»åˆ†** | **65** | **100** | |

---

**å®¡æ ¸äºº**: Codex (GPT-5.2)  
**å®¡æ ¸æ—¶é—´**: 2025-12-28 06:12ï¼ˆUTC+8ï¼‰

---

**å®¡æ ¸äºº**: Codex (GPT-5.2, reasoning_effort: xhigh)
**å®¡æ ¸æ—¶é—´**: 2025-12-28 06:54ï¼ˆUTC+8ï¼‰
**ä»»åŠ¡æ ‡è®°**: `[TASK_MARKER: 20251228-PHASE7-REVIEW-V2]`

---

# Phase 3: å¯é æ€§å±‚ P0/P1 ä¿®å¤åå®¡æ ¸æŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-29 00:23ï¼ˆUTC+8ï¼‰
**ä»»åŠ¡æ ‡è®°**: `[TASK_MARKER: 20251229-142200-P3RV]`
**å®¡æ ¸äºº**: Codex (GPT-5.2, reasoning_effort: xhigh)

---

## ç»¼åˆè¯„åˆ†: 82/100

**å®¡æ ¸ç»“è®º**: **éœ€è®¨è®ºï¼ˆå»ºè®®å¸¦æ¡ä»¶é€šè¿‡ï¼‰**

---

## P0 ä¿®å¤ç‚¹éªŒè¯ï¼ˆå·²é€šè¿‡ï¼‰

### 1) è°ƒåº¦å™¨å¡é˜Ÿåˆ—ï¼ˆscheduler.rsï¼‰

**ç»“è®º**: âœ… é€šè¿‡

å·²æ”¹ä¸º `Notify + background_worker` å¸¸é©»å¾ªç¯ï¼Œé˜Ÿåˆ—ç©ºæ—¶ç­‰å¾…é€šçŸ¥ã€æœ‰ä»»åŠ¡æ—¶é˜»å¡ç­‰å¾… permitï¼›ä»»åŠ¡å®Œæˆåé‡Šæ”¾ permit å¹¶ `notify_one()` æ¨è¿›åç»­å¤„ç†ã€‚

**è¯æ®**:
- `scheduler.rs:229`ï¼ˆqueue_notify å­—æ®µï¼‰
- `scheduler.rs:249`ï¼ˆå¯åŠ¨ workerï¼‰
- `scheduler.rs:359`ï¼ˆworker ä¸»å¾ªç¯ï¼‰
- `scheduler.rs:381`ï¼ˆç©ºé˜Ÿåˆ—ç­‰å¾… notifiedï¼‰
- `scheduler.rs:395`ï¼ˆç­‰å¾… acquire_ownedï¼‰
- `scheduler.rs:458`ï¼ˆdrop(permit)+notify_oneï¼‰
- `scheduler.rs:739`ï¼ˆé’ˆå¯¹æ€§æµ‹è¯• test_burst_submit_all_completeï¼‰

### 2) invalidate_plugin ç©ºå®ç°ï¼ˆcache.rsï¼‰

**ç»“è®º**: âœ… é€šè¿‡

å·²å¼•å…¥ `plugin_id -> keys` åå‘ç´¢å¼•å¹¶åœ¨ `invalidate_plugin` ä¸­ `remove()` å–å‡ºåæ‰¹é‡å¤±æ•ˆã€‚

**è¯æ®**:
- `cache.rs:197`ï¼ˆplugin_keys DashMapï¼‰
- `cache.rs:223`ï¼ˆregister_keyï¼‰
- `cache.rs:231`ï¼ˆunregister_keyï¼‰
- `cache.rs:319`ï¼ˆinvalidate_plugin å®ç°ï¼‰
- `cache.rs:598`ã€`cache.rs:646`ï¼ˆå•æµ‹è¦†ç›–ï¼‰

---

## P1 ä¿®å¤ç‚¹éªŒè¯

### 1) execute_many é™é»˜åé”™è¯¯

**ç»“è®º**: âœ… é€šè¿‡

å·²æ”¹ä¸ºå…ˆæ”¶é›†æ‰€æœ‰ submit ç»“æœï¼Œå†é€ä¸ªä¿ç•™ `Err(e)`ï¼ˆä¸å† `filter_map(ok)`ï¼‰ã€‚

**è¯æ®**: `scheduler.rs:537`ã€`scheduler.rs:553`ã€`scheduler.rs:559`

### 2) é˜Ÿåˆ—å®¹é‡æ£€æŸ¥éåŸå­

**ç»“è®º**: âœ… é€šè¿‡

å®¹é‡æ£€æŸ¥ä¸æ’å…¥å¤„äºåŒä¸€æŠŠ `queue.lock()` å†…ã€‚

**è¯æ®**: `scheduler.rs:318`ï¼ˆæŒé”ï¼‰ã€`scheduler.rs:321`ï¼ˆlen æ£€æŸ¥ï¼‰ã€`scheduler.rs:331`ï¼ˆinsertï¼‰

### 3) panic æ±¡æŸ“ç»Ÿè®¡

**ç»“è®º**: âœ… é€šè¿‡

æ–°å¢ `TaskPanic` å˜ä½“å¹¶ `catch_unwind` æ•è·ä»»åŠ¡ panicï¼›ç»Ÿè®¡æŒ‰ `TaskPanic` å•ç‹¬è®¡æ•°ã€‚

**è¯æ®**: `scheduler.rs:46`ï¼ˆTaskPanicï¼‰ã€`scheduler.rs:485`ï¼ˆcatch_unwindï¼‰ã€`scheduler.rs:448`ï¼ˆtotal_panicked è®¡æ•°ï¼‰

### 4) é‡è¯•é…ç½®ç¼ºæ ¡éªŒ

**ç»“è®º**: âš ï¸ éƒ¨åˆ†é€šè¿‡

å·²æ–°å¢ `RetryConfig::validate()` + `calculate_delay` / `add_jitter` clamp é˜²å¾¡ã€‚ä½†å½“å‰æœªå‘ç°è°ƒç”¨æ–¹ä½¿ç”¨ `validate()`ï¼Œéœ€ç¡®è®¤æ˜¯å¦æ•…æ„"ç”±ä¸Šå±‚è°ƒç”¨"ã€‚

**è¯æ®**: `retry.rs:123`ï¼ˆvalidateï¼‰ã€`retry.rs:371`ï¼ˆmultiplier clampï¼‰ã€`retry.rs:401`ï¼ˆjitter_factor clampï¼‰

### 5) é™æµé…ç½®ä¸ä¸€è‡´

**ç»“è®º**: âš ï¸ éƒ¨åˆ†é€šè¿‡

æ’ä»¶çº§é…ç½®ä¸º 0 æ—¶ä¼š `warn` å¹¶å›é€€åˆ° 1ï¼›å…¨å±€é…ç½®ä¸º 0 æ—¶ç›´æ¥è¿”å› `Err(ConfigError)`ï¼Œä¸¤è€…è¯­ä¹‰ä»ä¸ä¸€è‡´ï¼ˆä½†éƒ½ä¸ä¼š panicï¼‰ã€‚

**è¯æ®**: `rate_limiter.rs:162`ï¼ˆå…¨å±€ Errï¼‰ã€`rate_limiter.rs:284`ï¼ˆæ’ä»¶ warn+fallbackï¼‰

---

## å¯èƒ½å¼•å…¥çš„æ–°é—®é¢˜/é£é™©ï¼ˆå»ºè®®åç»­ä¼˜åŒ–ï¼‰

### 1) ç¼“å­˜åå‘ç´¢å¼•å¯èƒ½çªç ´å®¹é‡è¾¹ç•Œ

**é£é™©çº§åˆ«**: ä¸­

`plugin_keys` åªåœ¨ set/get_or_compute æ³¨å†Œã€invalidate/clear/invalidate_plugin æ¸…ç†ï¼Œä½†æœªä¸ moka çš„ TTL/TTI/å®¹é‡é©±é€è”åŠ¨ï¼›ç¼“å­˜æ¡ç›®è‡ªç„¶è¿‡æœŸ/è¢«é©±é€åç´¢å¼•ä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œå¯èƒ½æŒç»­å¢é•¿ã€‚

**è¯æ®**: `cache.rs:204`ï¼ˆbuilder æœªé…ç½®é©±é€å›è°ƒï¼‰

### 2) scheduler çš„ queue_length ç»Ÿè®¡å­˜åœ¨å¹¶å‘ä¸‹æº¢çª—å£

**é£é™©çº§åˆ«**: ä½

`queue_length.fetch_add` åœ¨é‡Šæ”¾é˜Ÿåˆ—é”åæ‰§è¡Œï¼Œå¤šçº¿ç¨‹ä¸‹ç†è®ºä¸Šå­˜åœ¨ä¸‹æº¢åˆ° `usize::MAX` çš„çª—å£ï¼ˆå½±å“ç»Ÿè®¡/ç›‘æ§ï¼‰ã€‚

**è¯æ®**: `scheduler.rs:335`ï¼ˆé‡Šæ”¾é”ç‚¹ï¼‰ã€`scheduler.rs:338`ï¼ˆfetch_addï¼‰ã€`scheduler.rs:428`ï¼ˆfetch_subï¼‰

### 3) shutdown ç»Ÿè®¡ä¸€è‡´æ€§

**é£é™©çº§åˆ«**: ä½

`shutdown()` drain é˜Ÿåˆ—ä½†æœªåŒæ­¥ä¿®æ­£ `stats.queue_length`ã€‚

**è¯æ®**: `scheduler.rs:610`

---

## è¯„åˆ†æ˜ç»†

| ç»´åº¦ | å¾—åˆ† | æ»¡åˆ† | è¯´æ˜ |
|------|------|------|------|
| æŠ€æœ¯æ­£ç¡®æ€§ | 27 | 30 | P0/P1 æ ¸å¿ƒä¿®å¤é—­ç¯ï¼Œå°‘æ•°è¾¹ç•Œè¯­ä¹‰ä¸å®Œå…¨ä¸€è‡´ |
| ä»£ç è´¨é‡ | 17 | 20 | æ•´ä½“è´¨é‡è‰¯å¥½ï¼Œå­˜åœ¨å°‘é‡ç»Ÿè®¡ä¸‹æº¢é£é™© |
| æ¶æ„è®¾è®¡ | 19 | 25 | æ¨¡å—è¾¹ç•Œæ¸…æ™°ï¼Œç¼“å­˜ç´¢å¼•æœªä¸é©±é€è”åŠ¨ |
| å®Œæ•´æ€§ | 19 | 25 | ä¸»è¦æµ‹è¯•è¦†ç›–ï¼Œå»ºè®®è¡¥å……è¾¹ç•Œç”¨ä¾‹ |
| **æ€»åˆ†** | **82** | **100** | |

---

## æµ‹è¯•å»ºè®®

å·²è¦†ç›–:
- burst æäº¤ä¸å†å¡é˜Ÿåˆ—ï¼ˆ`scheduler.rs:739`ï¼‰
- invalidate_plugin æ¸…ç†ï¼ˆ`cache.rs:598`ï¼‰
- é˜Ÿåˆ—æ»¡è¾¹ç•Œï¼ˆ`tests.rs:177`ï¼‰

å»ºè®®è¡¥:
- TaskPanic ç»Ÿè®¡ä¸è¿”å›è¯­ä¹‰å•æµ‹
- RetryConfig::validate çš„ä½¿ç”¨ç­–ç•¥å•æµ‹
- rate_limiter æ’ä»¶é…ç½®ä¸º 0 çš„ warn+fallback è¡Œä¸ºå•æµ‹

---

**æœ€ç»ˆç»“è®º**: **å¸¦æ¡ä»¶é€šè¿‡ï¼ˆ82/100 â‰¥ 80ï¼‰**

P0/P1 æ ¸å¿ƒé—®é¢˜å·²ä¿®å¤é—­ç¯ï¼Œå‰©ä½™é—®é¢˜ä¸º P2 çº§åˆ«ï¼Œä¸é˜»æ–­åˆå¹¶ã€‚

---

# Phase 3: P2 ä¼˜åŒ–åå¤å®¡æŠ¥å‘Š

**æ—¥æœŸ**: 2025-12-29 00:51ï¼ˆUTC+8ï¼‰
**ä»»åŠ¡æ ‡è®°**: `[TASK_MARKER: 20251229-004500-P3RV2]`
**å®¡æ ¸äºº**: Codex (GPT-5.2, reasoning_effort: xhigh)

---

## ç»¼åˆè¯„åˆ†: 88/100 âœ…

**å®¡æ ¸ç»“è®º**: **é€šè¿‡**ï¼ˆè¾ƒä¸Šæ¬¡ 82/100 æå‡ 6 åˆ†ï¼‰

---

## ä¿®å¤ç‚¹éªŒè¯

### ä¿®å¤1: RetryConfig::validate() è°ƒç”¨

**ç»“è®º**: âœ… å®Œå…¨é€šè¿‡

| éªŒè¯ç‚¹ | çŠ¶æ€ | è¯æ® |
|--------|------|------|
| new() è°ƒç”¨ validate() | âœ… | `retry.rs:259` |
| æ— æ•ˆé…ç½®è¿”å›æ­£ç¡®é”™è¯¯ | âœ… | `retry.rs:730`ï¼ˆå•æµ‹è¦†ç›–ï¼‰ |
| with_default_config() å®‰å…¨ | âœ… | `retry.rs:268`ï¼ˆexpect ä¿æŠ¤ï¼‰ |
| retry_with_config() é”™è¯¯å¤„ç† | âœ… | `retry.rs:442`ï¼ˆæ˜ å°„ä¸º NonRetryableï¼‰ |

### ä¿®å¤2: é™æµé…ç½®è¯­ä¹‰ä¸€è‡´æ€§

**ç»“è®º**: âœ… å®Œå…¨é€šè¿‡

| éªŒè¯ç‚¹ | çŠ¶æ€ | è¯æ® |
|--------|------|------|
| new() è¿”å› Self | âœ… | `rate_limiter.rs:164` |
| å…¨å±€ warn+fallback | âœ… | `rate_limiter.rs:169` |
| æ’ä»¶çº§ warn+fallback | âœ… | `rate_limiter.rs:305,308` |
| è°ƒè¯•æ—¥å¿— | âœ… | `rate_limiter.rs:190,335,360` |

---

## æµ‹è¯•è¦†ç›–

- âœ… `test_config_validation_in_new` - RetryConfig æ ¡éªŒï¼ˆ`retry.rs:730`ï¼‰
- âœ… `test_zero_config_fallback` - é™æµé›¶é…ç½® fallbackï¼ˆ`rate_limiter.rs:509`ï¼‰
- âœ… é›†æˆæµ‹è¯•é“¾è·¯æ­£å¸¸ï¼ˆ`tests.rs:103`ï¼‰

---

## è½»å¾®æ”¹è¿›å»ºè®®ï¼ˆä¸é˜»å¡ï¼‰

1. **RateLimitError::ConfigError** æœªä½¿ç”¨ï¼Œå¯èƒ½è§¦å‘ dead_code è­¦å‘Š
2. å»ºè®®è¡¥å…… `retry_with_config` æ— æ•ˆé…ç½®ç›´æ¥æ–­è¨€å•æµ‹

---

## è¯„åˆ†å¯¹æ¯”

| å®¡æ ¸ | è¯„åˆ† | çŠ¶æ€ |
|------|------|------|
| Phase 3 åˆå®¡ | 58/100 | âŒ ä¸é€šè¿‡ |
| P0/P1 ä¿®å¤å | 82/100 | âœ… å¸¦æ¡ä»¶é€šè¿‡ |
| **P2 ä¼˜åŒ–å** | **88/100** | **âœ… é€šè¿‡** |

---

**æœ€ç»ˆç»“è®º**: Phase 3 å¯é æ€§å±‚å®¡æ ¸é€šè¿‡ï¼Œå¯è¿›å…¥ Phase 4ã€‚

---

# Phase 7: P0/P1 ä¿®å¤åæ·±åº¦ä»£ç å®¡æ ¸ï¼ˆV2ï¼‰

**æ—¥æœŸ**: 2025-12-28 06:54ï¼ˆUTC+8ï¼‰

**å®¡æ ¸èŒƒå›´**:
- `src-tauri/src/commands/plugin.rs`ï¼ˆP0ï¼šå¤–å±‚é”ç§»é™¤éªŒè¯ï¼‰
- `src-tauri/src/commands/ipc.rs`ï¼ˆé”ç®€åŒ– + emit å¤±è´¥æ—¥å¿—ï¼‰
- `src-tauri/src/tray/mod.rs`ï¼ˆçª—å£æ“ä½œå¤±è´¥æ—¥å¿—ï¼šshow/hide/set_positionï¼‰
- `src-tauri/src/window/mod.rs`ï¼ˆçª—å£ç®¡ç†ï¼šshow/hide å¤±è´¥è·¯å¾„å¯è§‚æµ‹æ€§ï¼‰

**ç»¼åˆè¯„åˆ†**: 77/100  
**å®¡æ ¸ç»“è®º**: **éœ€è®¨è®º**ï¼ˆP0 å·²é€šè¿‡ï¼›P1 åœ¨ Tray/IPC è¦†ç›–åˆ°ä½ï¼Œä½† WindowManager ä»å­˜åœ¨ show/hide/set_focus é™é»˜å¿½ç•¥ç‚¹ï¼‰

---

## ä¿®å¤ç‚¹éªŒè¯ç»“æœ

### P0) å¤–å±‚é”ç§»é™¤ï¼ˆPluginManagerState: Arc<RwLock<PluginManager>> â†’ Arc<PluginManager>ï¼‰

**ç»“è®º**: é€šè¿‡

**è¯æ®**:
- `PluginManagerState` å·²æ”¹ä¸º `pub struct PluginManagerState(pub Arc<PluginManager>);`ï¼ˆ`src-tauri/src/commands/plugin.rs:13`ï¼‰ï¼Œå‘½ä»¤ä¸­ç›´æ¥è°ƒç”¨ `state.0.*`ï¼Œä¸å†å‡ºç°å¤–å±‚ `.read()`/`.write()`ï¼ˆ`src-tauri/src/commands/plugin.rs:17`ã€`src-tauri/src/commands/ipc.rs:22`ã€`src-tauri/src/commands/ipc.rs:34`ï¼‰ã€‚
- å…¨ä»“åº“æ£€ç´¢ `Arc<RwLock<PluginManager>>` æ— å‘½ä¸­ï¼Œç¡®è®¤æ—§å¤–å±‚é”ç±»å‹æ— æ®‹ç•™ï¼ˆå–è¯å‘½ä»¤è§ `.claude/operations-log.md`ï¼‰ã€‚

**å†…å±‚é”ç¡®è®¤**:
- `PluginManager` ä»ç»´æŒå†…å±‚ `plugins: RwLock<HashMap<String, PluginInstance>>`ï¼ˆ`src-tauri/src/plugin/lifecycle.rs:388`ã€`src-tauri/src/plugin/lifecycle.rs:392`ï¼‰ï¼Œè¯»å†™è·¯å¾„ä½¿ç”¨ `read().await` / `write().await`ï¼ˆä¾‹å¦‚ `src-tauri/src/plugin/lifecycle.rs:413`ã€`src-tauri/src/plugin/lifecycle.rs:449`ï¼‰ã€‚

**ä¸€è‡´æ€§éªŒè¯**:
- `cargo check` é€šè¿‡ï¼ˆä»… warningsï¼‰ï¼Œè¯´æ˜çŠ¶æ€ç±»å‹å˜æ›´æœªç ´å Tauri State æ³¨å…¥ä¸å‘½ä»¤ç­¾åï¼ˆå–è¯å‘½ä»¤è§ `.claude/operations-log.md`ï¼‰ã€‚

### P1) å…³é”®å¤±è´¥è·¯å¾„è¡¥å……æ—¥å¿—ï¼ˆemit/show/hide/set_position å¤±è´¥è®°å½• log::warn!ï¼‰

**ç»“è®º**: éƒ¨åˆ†é€šè¿‡ï¼ˆTray/IPC è¦†ç›–åˆ°ä½ï¼›WindowManager ä»æœ‰é™é»˜ç‚¹ï¼‰

**å·²è¦†ç›–ï¼ˆé€šè¿‡ï¼‰**:
- IPC emit å¤±è´¥æ—¥å¿—ï¼š
  - `plugin_enable` / `plugin_disable` åœ¨ `emit_plugin_error` å¤±è´¥æ—¶è®°å½• `log::warn!`ï¼ŒåŒ…å« `plugin` ä¸ `emit_error`ï¼ˆ`src-tauri/src/commands/ipc.rs:39`ã€`src-tauri/src/commands/ipc.rs:60`ï¼‰ã€‚
- æ‰˜ç›˜çª—å£æ“ä½œæ—¥å¿—ï¼š
  - `window.show()` / `window.hide()` / `window.set_focus()` å¤±è´¥å‡è®°å½• `log::warn!`ï¼ˆ`src-tauri/src/tray/mod.rs:147`ã€`src-tauri/src/tray/mod.rs:218`ã€`src-tauri/src/tray/mod.rs:225`ï¼‰ã€‚
  - `window.set_position(...)` å¤±è´¥è®°å½• `log::warn!`ï¼ŒåŒ…å« `x/y` ä¸ `error`ï¼ˆ`src-tauri/src/tray/mod.rs:265`ï¼‰ã€‚
  - æ‰˜ç›˜ refresh emit å¤±è´¥è®°å½• `log::warn!`ï¼ˆ`src-tauri/src/tray/mod.rs:157`ï¼‰ã€‚

**æœªè¦†ç›–ï¼ˆéœ€è®¨è®º/å»ºè®®è¡¥é½ï¼‰**:
- `WindowManager` çš„ show/hide/set_focus ä»å­˜åœ¨é™é»˜å¿½ç•¥ï¼š
  - `open()` å¯¹å·²å­˜åœ¨çª—å£ä½¿ç”¨ `let _ = window.show(); let _ = window.set_focus();`ï¼ˆ`src-tauri/src/window/mod.rs:116`ã€`src-tauri/src/window/mod.rs:117`ï¼‰ã€‚
  - `hide()` ä»…è¿”å› `is_ok()`ï¼Œå¤±è´¥ä¸è®°å½•åŸå› ï¼ˆ`src-tauri/src/window/mod.rs:173`ï¼‰ã€‚
  - `show()` åŒæ ·å¿½ç•¥ `show/set_focus` çš„ `Result`ï¼ˆ`src-tauri/src/window/mod.rs:182`ã€`src-tauri/src/window/mod.rs:183`ï¼‰ã€‚
- é™„å¸¦å‘ç°ï¼ˆéæœ¬æ¬¡å®¡æ ¸èŒƒå›´ä½†å±äºåŒç±»é—®é¢˜ï¼‰ï¼šå¯åŠ¨æ—¶éšè—ä¸»çª—å£ä»ä½¿ç”¨ `let _ = window.hide();`ï¼ˆ`src-tauri/src/lib.rs:84`ï¼‰ã€‚

---

## ä¸ä¸Šæ¬¡å®¡æ ¸çš„å¯¹æ¯”ï¼ˆåŸºçº¿ï¼š65/100ï¼‰

**å·²æ”¹å–„**:
- ä¸Šæ¬¡ä¸»è¦æ‰£åˆ†ç‚¹ä¹‹ä¸€â€œ**åŒå±‚é”å†—ä½™**â€å·²æ¶ˆé™¤ï¼š`PluginManagerState` å¤–å±‚é”ç§»é™¤ï¼Œé”è¯­ä¹‰å›å½’åˆ° `PluginManager.plugins` å•ä¸€ RwLockï¼ˆè§ P0 è¯æ®ï¼‰ã€‚
- ä¸Šæ¬¡â€œ**emit é™é»˜å¿½ç•¥**â€å·²éƒ¨åˆ†ä¿®å¤ï¼šIPC é”™è¯¯äº‹ä»¶ emit å¤±è´¥ä¸å†å®Œå…¨æ— ç—•ï¼ˆ`src-tauri/src/commands/ipc.rs:39`ã€`src-tauri/src/commands/ipc.rs:60`ï¼‰ï¼›æ‰˜ç›˜ refresh emit å¤±è´¥ä¹Ÿæœ‰ warnï¼ˆ`src-tauri/src/tray/mod.rs:157`ï¼‰ã€‚

**ä»æœªå®Œå…¨é—­ç¯**:
- Window ç®¡ç†å±‚ä»ä¿ç•™ show/hide/set_focus é™é»˜å¿½ç•¥ç‚¹ï¼ˆ`src-tauri/src/window/mod.rs:116`ã€`src-tauri/src/window/mod.rs:173`ã€`src-tauri/src/window/mod.rs:182`ï¼‰ï¼Œä¸â€œå…³é”®è·¯å¾„å¤±è´¥æ—¥å¿—è¡¥é½â€çš„ç›®æ ‡ä¸å®Œå…¨ä¸€è‡´ã€‚

---

## æ£€æŸ¥æ˜¯å¦å¼•å…¥æ–°é—®é¢˜ï¼ˆç»“è®ºï¼šæœªå‘ç°æ˜æ˜¾æ–°é—®é¢˜ï¼‰

**è§‚å¯Ÿ**:
- å¤–å±‚é”ç§»é™¤åï¼Œæ‰€æœ‰å¹¶å‘ä¿æŠ¤é›†ä¸­åœ¨ `PluginManager.plugins` å†…å±‚ `RwLock`ï¼Œå½“å‰ `PluginManager` é™¤ `plugins` å¤–æ— å…¶ä»–å¯å˜å­—æ®µï¼ˆ`src-tauri/src/plugin/lifecycle.rs:388`ï¼‰ï¼Œå› æ­¤å»é™¤å¤–å±‚é”ä¸ä¼šå‰Šå¼±å¹¶å‘å®‰å…¨æ€§ã€‚
- `cargo test -q` å½“å‰å¤±è´¥ï¼ŒåŸå› æ˜¯ `src-tauri/src/plugin/sandbox/fetch.rs` çš„ lifetime ç¼–è¯‘é”™è¯¯ï¼ˆéæœ¬æ¬¡ P0/P1 å˜æ›´è§¦å‘çš„å›å½’ï¼›ä½†ä¼šå½±å“æµ‹è¯•æ€éªŒè¯èƒ½åŠ›ï¼Œè¯¦è§ `.claude/operations-log.md`ï¼‰ã€‚

---

## è¯„åˆ†æ˜ç»†ï¼ˆ0-100ï¼‰

| ç»´åº¦ | å¾—åˆ† | æ»¡åˆ† | è¯´æ˜ |
|------|------|------|------|
| æŠ€æœ¯æ­£ç¡®æ€§ | 27 | 30 | P0 é”ç§»é™¤åç¼–è¯‘é€šè¿‡ï¼›å†…å±‚ RwLock ä»æ­£ç¡®ï¼›P1 æ–°å¢ warn ä¸æ”¹å˜åŸæœ‰è¿”å›è¯­ä¹‰ |
| æ¶æ„è®¾è®¡ | 22 | 25 | åŒå±‚é”å·²æ¶ˆé™¤ï¼›ä½† WindowManager ä»ä»¥ bool/å¿½ç•¥ Result éšè—é”™è¯¯ä¸Šä¸‹æ–‡ï¼Œä¸”åŒå‘½ä»¤è·¯å¾„ä»å¹¶å­˜ |
| å®‰å…¨æ€§ | 16 | 20 | æœ¬æ¬¡å˜æ›´æœªå¼•å…¥æ–°çš„æ˜¾è‘—é£é™©ï¼›æ—¥å¿—æœªè¾“å‡ºæ•æ„Ÿ payloadï¼ˆä¸»è¦ä¸º label/id ä¸é”™è¯¯å­—ç¬¦ä¸²ï¼‰ |
| å®Œæ•´æ€§ | 12 | 25 | P0 å®Œæˆï¼›P1 åœ¨ Tray/IPC è¦†ç›–åˆ°ä½ä½† WindowManager ä»æœ‰ç¼ºå£ï¼›æ­¤å¤– ipc.rs å¤šå‘½ä»¤ä»ä¸ºå ä½å®ç° |
| **æ€»åˆ†** | **77** | **100** | |

---

## Phase 7 P1 æœ€ç»ˆå®¡æ ¸ï¼ˆV3ï¼šæ—¥å¿—è¡¥é½é—­ç¯ï¼‰

**ä»»åŠ¡**: `[TASK_MARKER: 20251228-PHASE7-REVIEW-V3]`

**æ—¥æœŸ**: 2025-12-28 07:16ï¼ˆUTC+8ï¼‰

**å®¡æ ¸èŒƒå›´**:
- `src-tauri/src/window/mod.rs`ï¼ˆWindowManager æ—¥å¿—è¡¥é½éªŒè¯ï¼‰
- `src-tauri/src/lib.rs`ï¼ˆå¯åŠ¨æµç¨‹æ—¥å¿—éªŒè¯ï¼‰
- `src-tauri/src/commands/ipc.rs`ï¼ˆemit æ—¥å¿—éªŒè¯ï¼‰
- `src-tauri/src/tray/mod.rs`ï¼ˆæ‰˜ç›˜æ“ä½œæ—¥å¿—éªŒè¯ï¼‰

---

## è¡¥å……ä¿®å¤ç‚¹æ ¸å¯¹ï¼ˆç»“è®ºï¼šå…¨éƒ¨å·²ä¿®å¤ï¼‰

### 1) WindowManager æ—¥å¿—è¡¥é½

**ç»“è®º**: é€šè¿‡

**è¯æ®**:
- `open()`ï¼šå¯¹å·²å­˜åœ¨çª—å£ï¼Œ`show()`/`set_focus()` å¤±è´¥å‡è®°å½• `log::warn!`ï¼ˆ`src-tauri/src/window/mod.rs:116-121`ï¼‰ã€‚
- `hide()`ï¼šæ”¹ä¸º `match` å¹¶åœ¨å¤±è´¥æ—¶è®°å½• `log::warn!`ï¼ˆ`src-tauri/src/window/mod.rs:177-183`ï¼‰ã€‚
- `show()`ï¼š`show()` å¤±è´¥è®°å½• `log::warn!` ä¸”è¿”å› `false`ï¼›`set_focus()` å¤±è´¥è®°å½• `log::warn!`ï¼ˆ`src-tauri/src/window/mod.rs:192-198`ï¼‰ã€‚

### 2) å¯åŠ¨æµç¨‹ hide() å¤±è´¥æ—¥å¿—

**ç»“è®º**: é€šè¿‡

**è¯æ®**:
- å¯åŠ¨æ—¶éšè—ä¸»çª—å£å¤±è´¥ä¼šè®°å½• `log::warn!`ï¼ˆ`src-tauri/src/lib.rs:84-86`ï¼‰ã€‚

### 3) IPC emit å¤±è´¥æ—¥å¿—

**ç»“è®º**: é€šè¿‡

**è¯æ®**:
- `plugin_enable` / `plugin_disable`ï¼š`emit_plugin_error` å¤±è´¥ä¼šè®°å½• `log::warn!`ï¼ˆ`src-tauri/src/commands/ipc.rs:39-41`ã€`src-tauri/src/commands/ipc.rs:60-62`ï¼‰ã€‚

**å¤‡æ³¨**:
- `IpcEventEmitter` æœ¬èº«ä»è¿”å› `Result<(), tauri::Error>`ï¼ˆ`src-tauri/src/commands/events.rs:56-106`ï¼‰ï¼Œå½“å‰ç”±è°ƒç”¨ç«¯è´Ÿè´£è®°å½• emit å¤±è´¥æ—¥å¿—ï¼ŒèŒè´£è¾¹ç•Œæ¸…æ™°ã€‚

### 4) æ‰˜ç›˜æ“ä½œæ—¥å¿—

**ç»“è®º**: é€šè¿‡

**è¯æ®**:
- æ‰˜ç›˜èœå•ç‚¹å‡»æœ‰ debug æ—¥å¿—ï¼ˆ`src-tauri/src/tray/mod.rs:140-142`ï¼‰ã€‚
- ä¸»çª—å£ `show()`/`hide()`/`set_focus()` å¤±è´¥å‡è®°å½• `log::warn!`ï¼ˆ`src-tauri/src/tray/mod.rs:147-152`ã€`src-tauri/src/tray/mod.rs:218-230`ï¼‰ã€‚
- refresh äº‹ä»¶ emit å¤±è´¥è®°å½• `log::warn!`ï¼ŒæˆåŠŸè®°å½• `log::info!`ï¼ˆ`src-tauri/src/tray/mod.rs:157-161`ï¼‰ã€‚

---

## æ˜¯å¦ä»æœ‰é—æ¼ï¼ˆèŒƒå›´å†…æ£€æŸ¥ï¼‰

**ç»“è®º**: æœªå‘ç°åŒç±»â€œé™é»˜å¿½ç•¥ Resultâ€æ®‹ç•™

**è¯æ®**:
- å…¨é‡æ£€ç´¢ `src-tauri/src` ä¸‹ `\\.show\\(|\\.hide\\(|\\.set_focus\\(|\\.emit\\(` è°ƒç”¨ç‚¹ï¼Œå½“å‰å‡å·²å…·å¤‡é”™è¯¯å¤„ç†/æ—¥å¿—ï¼Œæˆ–ä»¥ `Result` å½¢å¼å‘ä¸Šè¿”å›ï¼ˆå–è¯å‘½ä»¤è§ `.claude/operations-log.md`ï¼‰ã€‚

**è½»å¾®æ”¹è¿›å»ºè®®ï¼ˆéé˜»å¡ï¼‰**:
- `WindowManager::open` çš„ `builder.build()` å¤±è´¥æ—¥å¿—å½“å‰æœªæºå¸¦ `label`ï¼ˆ`src-tauri/src/window/mod.rs:144-152`ï¼‰ï¼Œå»ºè®®è¡¥å…… `label` ä»¥æå‡æ’éšœæ•ˆç‡ã€‚
- `WindowManager::close` çš„å¤±è´¥æ—¥å¿—åŒæ ·å¯è¡¥å…… `label`ï¼ˆ`src-tauri/src/window/mod.rs:159-167`ï¼‰ã€‚

---

## è¯„åˆ†æ˜ç»†ï¼ˆV3ï¼‰

| ç»´åº¦ | å¾—åˆ† | æ»¡åˆ† | è¯´æ˜ |
|------|------|------|------|
| æŠ€æœ¯æ­£ç¡®æ€§ | 28 | 30 | show/hide/set_focus/emit å¤±è´¥è·¯å¾„å‡å¯è§‚æµ‹ï¼›è¿”å›è¯­ä¹‰ä¿æŒç¨³å®šï¼ˆbool/Option æœªæ”¹å˜ï¼‰ |
| æ¶æ„è®¾è®¡ | 22 | 25 | æ—¥å¿—åˆ†å±‚æ¸…æ™°ï¼ˆWindowManager/Tray/IPC è°ƒç”¨ç«¯è´Ÿè´£ï¼‰ï¼›ä»æœ‰å°‘é‡æ—¥å¿—ä¸Šä¸‹æ–‡å¯å¢å¼ºç‚¹ï¼ˆlabelï¼‰ |
| å®‰å…¨æ€§ | 18 | 20 | æ–°å¢æ—¥å¿—æœªåŒ…å«æ•æ„Ÿ payloadï¼Œä»…å« label/id ä¸é”™è¯¯å­—ç¬¦ä¸²ï¼›æ•´ä½“é£é™©å¯æ§ |
| å®Œæ•´æ€§ | 20 | 25 | æœ¬æ¬¡ P1 æ—¥å¿—è¡¥é½é—­ç¯ï¼›èŒƒå›´å†…æœªå‘ç°é™é»˜å¿½ç•¥ï¼›ä½†ä»å­˜åœ¨å°‘é‡éé˜»å¡çš„ä¸Šä¸‹æ–‡å¢å¼ºç©ºé—´ |
| **æ€»åˆ†** | **88** | **100** | |

**æœ€ç»ˆç»“è®º**: **é€šè¿‡ï¼ˆPassï¼‰**

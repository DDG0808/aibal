# Claude 使用量追踪器 - 完整功能清单（中文版）

> 基于 hamed-elfayome/Claude-Usage-Tracker v1.5.0 源码分析
> **审核状态**: 已通过 Codex (gpt-5.2 xhigh) 审核并修正

---

## 一、项目概述

| 属性 | 描述 |
|------|------|
| **类型** | macOS 跨平台菜单栏应用 |
| **技术栈** | Rust + Tauri 2.0 / Vue 3.x (TypeScript) |
| **最低系统** | macOS 10.15 (Catalina) |
| **架构模式** | Tauri IPC + Vue Composition API |
| **存储方案** | SQLite + tauri-plugin-store |
| **网络层** | reqwest (async) / Tauri HTTP Plugin |
| **平台范围** | 仅支持 macOS（未来可扩展 Windows/Linux）|

---

## 二、核心功能模块

### 2.1 使用量监控系统 (ClaudeAPIService)

#### 2.1.1 数据获取
| 功能点 | 描述 | API 端点 |
|--------|------|----------|
| 获取组织 ID | 从组织列表获取首个 uuid | `GET /api/organizations` |
| 获取使用量数据 | 获取完整使用统计 | `GET /api/organizations/{org_id}/usage` |
| 获取超额消费限额 | 检查 Extra 费用限制 | `GET /api/organizations/{org_id}/overage_spend_limit` |
| 创建会话 | 创建新对话 | `POST /api/organizations/{org_id}/chat_conversations` |
| 发送初始化消息 | 使用 Haiku 模型发送消息 | `POST /api/organizations/{org_id}/chat_conversations/{uuid}/completion` |

> **注意**: 初始化消息为两步操作：先创建会话，再发送 completion

#### 2.1.2 使用量数据模型 (ClaudeUsage)
| 字段 | 类型 (TS/Rust) | 描述 |
|------|------|------|
| `sessionTokensUsed` | `number` / `i64` | 5小时会话已用 Token |
| `sessionLimit` | `number` / `i64` | 5小时会话 Token 限额 |
| `sessionPercentage` | `number` / `f64` | 5小时会话使用百分比 |
| `sessionResetTime` | `string` / `DateTime<Utc>` | 会话重置时间 (ISO 8601) |
| `weeklyTokensUsed` | `number` / `i64` | 周使用 Token（全模型）|
| `weeklyLimit` | `number` / `i64` | 周 Token 限额 |
| `weeklyPercentage` | `number` / `f64` | 周使用百分比 |
| `weeklyResetTime` | `string` / `DateTime<Utc>` | 周重置时间 (ISO 8601) |
| `opusWeeklyTokensUsed` | `number` / `i64` | Opus 模型周用量 |
| `opusWeeklyPercentage` | `number` / `f64` | Opus 模型周使用百分比 |
| `costUsed` | `number?` / `Option<f64>` | Extra 已用费用 |
| `costLimit` | `number?` / `Option<f64>` | Extra 费用限额 |
| `costCurrency` | `string?` / `Option<String>` | 费用货币单位 |
| `lastUpdated` | `string` / `DateTime<Utc>` | 最后更新时间 |
| `userTimezone` | `string` / `String` | 用户时区 (IANA) |

#### 2.1.3 使用量状态级别
| 级别 | 百分比范围 | 颜色 |
|------|-----------|------|
| `safe` | 0% - 50% | 绿色 |
| `moderate` | 50% - 80% | 橙色 |
| `critical` | 80% - 100% | 红色 |

---

### 2.2 系统托盘管理器 (TrayManager)

#### 2.2.1 状态栏图标
- [x] 自定义菜单栏图标显示（"Claude" 文字 + 电池条）
- [x] 电池风格进度条可视化
- [x] 颜色编码状态指示（绿/橙/红）
- [x] 深色/浅色外观自适应重绘

> **注意**: 菜单栏不显示百分比数字，仅显示电池条

#### 2.2.2 弹窗管理
- [x] 点击图标弹出详细信息窗口
- [x] 弹窗可拖拽分离为独立窗口
- [x] 点击外部自动关闭弹窗
- [x] 多显示器支持

#### 2.2.3 数据刷新
- [x] 自动定时刷新（可配置间隔）
- [x] 手动刷新按钮
- [x] 并行获取使用量 + 系统状态

---

### 2.3 托盘弹窗界面 (TrayPopover.vue)

#### 2.3.1 智能头部 (SmartHeader)
- [x] Logo 显示
- [x] Claude 系统状态指示器
- [x] 刷新按钮（带加载动画）

#### 2.3.2 使用量仪表盘 (SmartUsageDashboard)
- [x] 5小时会话使用量卡片
  - 使用百分比显示
  - 重置时间点显示（非倒计时）
- [x] 周使用量卡片
  - 全模型周用量
  - 百分比进度条
- [x] Opus 周使用量卡片（条件显示）
- [x] Extra 费用卡片（条件显示）
  - 已用/限额费用
  - 货币单位

> **注意**: 弹窗仅显示百分比，不显示具体 Token 数量

#### 2.3.3 上下文洞察 (ContextualInsights)
- [ ] 智能建议显示（**UI 预留，未接入**）
- [ ] 展开/收起动画（**UI 预留，未接入**）

> **注意**: `showInsights` 状态变量未被任何控件修改

#### 2.3.4 操作按钮区
- [x] 设置按钮 (Settings 图标)
- [x] 退出按钮 (Power 图标)
- [x] 按钮悬停效果

---

### 2.4 通知系统 (NotificationManager)

#### 2.4.1 使用量阈值告警
| 阈值 | 百分比 | 实现状态 |
|------|--------|----------|
| `warning` | 75% | ✅ 已实现 |
| `high` | 90% | ⚠️ 常量定义但未使用 |
| `critical` | 95% | ✅ 已实现 |

> **注意**: 代码中仅实现 75% 和 95% 两个阈值，90% 为常量预留

#### 2.4.2 事件通知
- [x] 会话重置通知（0% 重置时）
- [x] 自动启动会话成功通知
- [x] macOS 原生通知集成
- [x] 前台应用时也显示通知（banner + sound）

> 前台通知由 Tauri 事件系统 + tauri-plugin-notification 实现

#### 2.4.3 自动会话启动
- [x] 检测使用量从 >0% 降到 0%
- [x] 自动使用 Claude 3.5 Haiku 发送初始化消息
- [x] 可配置开关
- [x] 静默失败处理

---

### 2.5 设置界面 (SettingsPage.vue)

#### 2.5.1 侧边栏导航
| Tab | 图标 | 描述 |
|-----|------|------|
| API | Key 图标 | API 密钥配置 |
| 通用 | Settings 图标 | 通用设置 |
| 会话 | RefreshCw 图标 | 会话管理 |
| 通知 | Bell 图标 | 通知设置 |
| Claude Code | Terminal 图标 | 终端集成 |
| 关于 | Info 图标 | 关于信息 |

#### 2.5.2 API 设置 (APIView)
- [x] Session Key 输入框
- [x] 密钥验证功能
- [x] 获取密钥教程链接
- [x] 密钥格式校验（sk-ant- 前缀）

#### 2.5.3 通用设置 (GeneralView)
- [x] 刷新间隔滑块（5-120秒）
- [x] 实时预览刷新间隔值
- [x] 超额消费检查开关（默认值：true）

#### 2.5.4 会话设置 (SessionView)
- [x] 自动启动会话开关
- [x] 功能说明文字

#### 2.5.5 通知设置 (NotificationsView)
- [x] 通知总开关
- [x] 请求系统通知权限
- [x] 权限状态显示

#### 2.5.6 Claude Code 设置 (StatuslineView)
- [x] 显示目录名开关
- [x] 显示 Git 分支开关
- [x] 显示使用百分比开关
- [x] 显示进度条开关
- [x] 实时预览效果
- [x] 应用配置按钮
- [x] 重置配置按钮
- [x] 状态反馈消息

#### 2.5.7 关于页面 (AboutView)
- [x] 应用 Logo
- [x] 版本号显示
- [x] 贡献者列表（从 GitHub API 获取）
- [x] GitHub 仓库链接
- [ ] 许可证信息（**UI 未实现**）

---

### 2.6 首次设置向导 (SetupWizard.vue)

#### 2.6.1 向导流程
- [x] 欢迎页面（Logo + 标题）
- [x] Session Key 输入区域
- [x] 获取密钥步骤说明（展开/收起）
- [x] 自动启动会话选项

#### 2.6.2 密钥验证
- [x] 格式校验（sk-ant- 前缀）
- [x] 在线连接验证
- [x] 验证状态显示（idle/validating/success/error）
- [x] 验证成功后显示组织 ID

#### 2.6.3 向导控制
- [x] 取消按钮
- [x] 验证按钮（动态文字/加载动画）
- [x] 完成按钮（验证成功后显示）

#### 2.6.4 兜底逻辑
- [x] 若 `~/.claude-session-key` 已存在，自动标记设置完成

---

### 2.7 Claude Code 终端状态栏集成 (StatuslineService)

#### 2.7.1 脚本文件
| 文件 | 路径 | 功能 |
|------|------|------|
| `fetch-claude-usage` | `~/.claude/` | 获取使用量数据 (CLI 工具) |
| `statusline-command.sh` | `~/.claude/` | 构建状态栏显示 |
| `statusline-config.txt` | `~/.claude/` | 组件配置 |
| `settings.json` | `~/.claude/` | Claude Code 设置 |

#### 2.7.2 状态栏格式
```
directory │ ⎇ branch │ Usage: 25% ▓▓░░░░░░░░ → Reset: 3:45 PM
```

#### 2.7.3 可配置组件
- [x] 当前目录名
- [x] Git 分支名
- [x] 使用百分比
- [x] 10段进度条（▓░）
- [x] 重置时间点

#### 2.7.4 安装/卸载
- [x] 自动安装脚本到 ~/.claude/
- [x] 设置脚本权限（755）
- [x] 更新 settings.json
- [x] 重置/移除功能

---

### 2.8 系统状态监测 (ClaudeStatusService)

#### 2.8.1 状态级别 (ClaudeStatus)
| 级别 | 描述 | 颜色 |
|------|------|------|
| `none` | 系统正常 | 绿色 |
| `minor` | 轻微问题 | 黄色 |
| `major` | 重大故障 | 橙色 |
| `critical` | 严重故障 | 红色 |
| `unknown` | 无法获取 | 灰色 |

#### 2.8.2 状态获取
- [x] 从 statuspage.io 获取 Claude 系统状态
- [x] 10秒超时设置
- [x] 错误降级处理

---

### 2.9 数据持久化 (DataStore)

#### 2.9.1 存储键值
| 键名 | 类型 (TS/Rust) | 默认值 | 描述 |
|------|------|--------|------|
| `claudeUsageData` | `object` / `Value` | - | 使用量数据 JSON |
| `notificationsEnabled` | `boolean` / `bool` | true | 通知开关 |
| `refreshInterval` | `number` / `f64` | 30 | 刷新间隔 |
| `autoStartSessionEnabled` | `boolean` / `bool` | false | 自动启动会话 |
| `statuslineShowDirectory` | `boolean` / `bool` | true | 显示目录 |
| `statuslineShowBranch` | `boolean` / `bool` | true | 显示分支 |
| `statuslineShowUsage` | `boolean` / `bool` | true | 显示使用率 |
| `statuslineShowProgressBar` | `boolean` / `bool` | true | 显示进度条 |
| `firstLaunchDate` | `string?` / `Option<DateTime>` | - | 首次启动日期 |
| `lastGitHubStarPromptDate` | `string?` / `Option<DateTime>` | - | 上次提示日期 |
| `hasStarredGitHub` | `boolean` / `bool` | false | 是否已 Star |
| `neverShowGitHubPrompt` | `boolean` / `bool` | false | 不再提示 |
| `hasCompletedSetup` | `boolean` / `bool` | false | 已完成设置 |
| `checkOverageLimitEnabled` | `boolean` / `bool` | true | 检查超额限制 |

#### 2.9.2 数据存储方案
- [x] tauri-plugin-store 管理配置
- [x] SQLite 储存缓存数据

---

### 2.10 GitHub Star 提示 (GitHubStarModal.vue)

#### 2.10.1 显示条件
- [x] 首次启动后 1 天
- [x] 如已显示过，间隔 10 天再次提示
- [x] 用户选择"不再提示"后永不显示
- [x] 用户已 Star 后永不显示

#### 2.10.2 交互选项
- [x] "Star on GitHub" 按钮
- [x] "Maybe Later" 按钮
- [x] "Don't Ask Again" 按钮

#### 2.10.3 测试支持
- [x] 启动参数 `--show-github-prompt` 强制触发提示

---

## 三、安全特性

| 特性 | 描述 |
|------|------|
| **本地存储** | Session Key 存储在 `~/.claude-session-key` |
| **文件权限** | 密钥文件权限设置为 0600 |
| **无云同步** | 所有数据仅存储在本地 |
| **无遥测** | 零追踪、零分析 |
| **HTTPS** | 仅通过 HTTPS 与 claude.ai 通信 |
| **macOS App Sandbox** | 禁用 App Sandbox 以访问文件系统（插件 JS Runtime 仍在严格沙箱中运行）|

---

## 四、应用生命周期

### 4.1 Tauri 启动流程 (main.rs)
- [x] 初始化日志系统 (tracing)
- [x] 创建系统托盘 (SystemTray)
- [x] 注册 IPC Commands
- [x] 注册事件监听器
- [x] 检查首次设置状态
- [x] 设置自动更新 (tauri-plugin-updater)
- [x] 隐藏 Dock 图标 (macOS: activation_policy)

### 4.2 窗口管理
| 窗口类型 | 实现方式 | 特性 |
|----------|----------|------|
| 托盘弹窗 | WebviewWindow (无边框) | transparent, decorations: false |
| 设置窗口 | WebviewWindow (标准) | resizable, titlebar |
| 设置向导 | WebviewWindow (标准) | center, modal-like |

### 4.3 多窗口状态同步
- [x] Tauri Events 广播状态变更
- [x] Pinia Store 监听事件更新
- [x] Window Focus 事件处理

---

## 五、项目结构与资源

### 5.1 Rust 后端 (src-tauri/)
| 目录/文件 | 用途 |
|-----------|------|
| `src/main.rs` | 入口点、Tauri 初始化 |
| `src/commands/` | IPC Command 处理器 |
| `src/services/` | 业务逻辑服务 |
| `src/state.rs` | 应用状态管理 |
| `tauri.conf.json` | Tauri 配置 |
| `icons/` | 应用图标（多尺寸 PNG/ICO） |

### 5.2 Vue 前端 (src/)
| 目录/文件 | 用途 |
|-----------|------|
| `components/` | Vue 组件 |
| `views/` | 页面视图 |
| `stores/` | Pinia 状态管理 |
| `assets/` | 静态资源（图片、字体） |
| `styles/` | 全局样式 |

### 5.3 配置文件
| 文件 | 用途 |
|------|------|
| `tauri.conf.json` | Tauri 应用配置 |
| `vite.config.ts` | Vite 构建配置 |
| `tsconfig.json` | TypeScript 配置 |

---

## 六、测试覆盖

### 6.1 Rust 后端测试
| 测试类型 | 框架 | 命令 |
|----------|------|------|
| 单元测试 | `#[cfg(test)]` | `cargo test` |
| 集成测试 | `tests/` 目录 | `cargo test --test '*'` |

### 6.2 Vue 前端测试
| 测试类型 | 框架 | 命令 |
|----------|------|------|
| 组件测试 | Vitest + Vue Test Utils | `npm run test:unit` |
| E2E 测试 | Playwright (可选) | `npm run test:e2e` |

---

## 七、常量配置 (Constants)

### 7.1 刷新间隔
| 场景 | 间隔 |
|------|------|
| 菜单栏 | 30秒 |
| 小 Widget | 15分钟 |
| 中 Widget | 15分钟 |
| 大 Widget | 30分钟 |

### 7.2 通知阈值
| 级别 | 百分比 | 状态 |
|------|--------|------|
| 警告 | 75% | ✅ 已实现 |
| 高位 | 90% | ⚠️ 常量预留 |
| 临界 | 95% | ✅ 已实现 |

### 7.3 GitHub 提示时机
| 场景 | 间隔 |
|------|------|
| 首次提示延迟 | 1天 |
| 再次提示间隔 | 10天 |

---

## 八、功能统计

| 类别 | 数量 |
|------|------|
| 核心模块 | 10 |
| 视图组件 | 15+ |
| API 端点 | 5 |
| 数据存储键 | 14 |
| 设置选项 | 8 |
| 通知类型 | 4 (实际实现) |

---


## 九、插件系统 - 中转站余额查询

> 插件系统设计详见独立文档：[插件系统设计文档.md](./插件系统设计文档.md)
> 
> **简要概述**：支持 JS 插件查询第三方中转站余额，基于 QuickJS 沙盒执行。

### 功能概览

| 模块 | 描述 | 状态 |
|------|------|------|
| 插件管理器 | 加载/卸载/热重载 JS 插件 | [ ] |
| 并发调度器 | 多中转站并行查询 | [ ] |
| JS 沙盒 | QuickJS 安全执行环境 | [ ] |
| 缓存/限流 | LRU 缓存 + Governor 限流 | [ ] |

---

## 十、Tauri IPC 接口契约

### 10.1 Commands 定义

| Command | 参数 | 返回值 | 描述 |
|---------|------|--------|------|
| `get_usage` | - | `ClaudeUsage` | 获取当前使用量 |
| `refresh_usage` | - | `ClaudeUsage` | 强制刷新使用量 |
| `get_system_status` | - | `ClaudeStatus` | 获取系统状态 |
| `validate_session_key` | `key: string` | `CommandResult<OrgInfo>` | 验证密钥 |
| `save_settings` | `settings: Settings` | `CommandResult<void>` | 保存设置 |
| `get_settings` | - | `Settings` | 获取设置 |
| `start_auto_session` | - | `CommandResult<void>` | 启动自动会话 |

### 10.2 Events 定义

| Event | 方向 | Payload | 描述 |
|-------|------|---------|------|
| `usage-updated` | Backend → Frontend | `ClaudeUsage` | 使用量更新 |
| `status-changed` | Backend → Frontend | `ClaudeStatus` | 系统状态变化 |
| `notification` | Backend → Frontend | `Notification` | 通知消息 |
| `tray-clicked` | Backend → Frontend | - | 托盘图标点击 |

### 10.3 数据结构

```typescript
// 前端类型定义 (src/types/index.ts)
interface ClaudeUsage {
  sessionPercentage: number;
  sessionResetTime: string;  // ISO 8601
  weeklyPercentage: number;
  weeklyResetTime: string;   // ISO 8601
  opusWeeklyPercentage?: number;
  costUsed?: number;
  costLimit?: number;
  costCurrency?: string;
}

interface ClaudeStatus {
  indicator: 'none' | 'minor' | 'major' | 'critical' | 'unknown';
  description: string;
}

interface Settings {
  refreshInterval: number;
  notificationsEnabled: boolean;
  autoStartSession: boolean;
  checkOverageLimit: boolean;
}

// 密钥验证返回的组织信息
interface OrgInfo {
  uuid: string;
  name: string;
  createdAt: string;  // ISO 8601
}

// 通知消息结构
interface Notification {
  id: string;
  type: 'warning' | 'critical' | 'info' | 'success';
  title: string;
  body: string;
  timestamp: string;  // ISO 8601
}

// 统一错误结构
interface AppError {
  code: string;       // 错误码，如 'AUTH_FAILED', 'NETWORK_ERROR'
  message: string;    // 用户可读的错误信息
  details?: unknown;  // 可选的详细信息
}

// Tauri Command 返回类型
type CommandResult<T> = { ok: T } | { err: AppError };
```


---
## 十一、未实现/预留功能

| 功能 | 位置 | 状态 |
|------|------|------|
| 上下文洞察展开/收起 | TrayPopover.vue | UI 预留 |
| 90% 高位通知 | notification_service.rs | 常量预留 |
| 许可证信息展示 | AboutPage.vue | 未实现 |

---

**文档更新时间**: 2025-12-27
**技术栈**: Rust + Tauri 2.0 / Vue 3.x (TypeScript)
**分析工具**: Auggie (codebase-retrieval)
**审核工具**: Codex (gpt-5.2 + xhigh reasoning)
